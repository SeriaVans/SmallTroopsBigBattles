# 遊戲設計文檔 - 核心機制

## 遊戲類型定義

```
類型: 劇本制 SLG (Scenario-based Strategy Game)
特點: 節點式地圖 + 賽季制 + 國家陣營
參考: 率土之濱、三國志戰略版、萬國覺醒
```

---

## 1. 節點式地圖系統

### 1.1 地圖結構

```
┌─────────────────────────────────────────────────────────────┐
│                      世界地圖示意                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                        [王城]                               │
│                       ╱  │  ╲                              │
│                     ╱    │    ╲                            │
│               [關隘]   [關隘]   [關隘]                       │
│                 │        │        │                         │
│     ┌───────────┴────────┴────────┴───────────┐            │
│     │                                          │            │
│   [城A1]────[城A2]      [城B1]────[城B2]       │            │
│     │          │          │          │         │            │
│   [城A3]────[城A4]      [城B3]────[城B4]       │            │
│     │                                │         │            │
│     └────────────────────────────────┘         │            │
│           國家A區域        國家B區域             │            │
│                                                             │
│   ※ 線條 = 可行軍路線                                       │
│   ※ 城池之間只能沿路線移動                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 節點類型

| 節點類型 | 說明 | 功能 |
|---------|------|------|
| **主城 (Capital)** | 國家首都 | 國家核心，失守則國家滅亡 |
| **城池 (City)** | 普通城市 | 玩家建設領地的位置 |
| **關隘 (Pass)** | 戰略要地 | 連接不同區域，易守難攻 |
| **資源點 (Resource)** | 資源產出 | 提供額外資源加成 |
| **王城 (Throne)** | 最終目標 | 劇本勝利條件 |

### 1.3 路線系統

```csharp
// 路線數據結構
public class MapRoute
{
    public int RouteId;
    public int FromNodeId;      // 起點節點
    public int ToNodeId;        // 終點節點
    public int Distance;        // 距離 (影響行軍時間)
    public TerrainType Terrain; // 地形類型
    public bool IsTwoWay;       // 是否雙向通行
}

// 地形類型
public enum TerrainType
{
    Plain,      // 平原 - 速度正常
    Mountain,   // 山地 - 速度減慢
    Forest,     // 森林 - 速度稍慢，有伏擊加成
    River,      // 河流 - 需要渡河時間
    Pass        // 關隘 - 防守方加成
}
```

### 1.4 行軍規則

```
1. 部隊只能沿路線移動
2. 行軍時間 = 基礎時間 × 地形係數 × 部隊速度
3. 途中遭遇敵軍 → 觸發戰鬥
4. 可設置中途停靠點
5. 可選擇繞路避開敵軍
```

---

## 2. 劇本制系統

### 2.1 劇本概念

```
┌─────────────────────────────────────────────────────────────┐
│                        劇本生命週期                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [開服] → [發展期] → [爭霸期] → [決戰期] → [結算] → [新劇本] │
│    │         │          │          │         │              │
│   Day1    Day1-14    Day15-28   Day29-42   Day43+           │
│                                                             │
│  ※ 時間僅為示例，可根據設計調整                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 劇本階段

| 階段 | 時間 | 特點 | 開放內容 |
|------|------|------|---------|
| **發展期** | 第1-14天 | 和平發展 | 國內 PvE，禁止跨國攻擊 |
| **爭霸期** | 第15-28天 | 開放 PvP | 可攻擊敵國城池 |
| **決戰期** | 第29-42天 | 爭奪王城 | 王城開放攻擊 |
| **結算期** | 第43天+ | 劇本結束 | 結算獎勵，準備新劇本 |

### 2.3 劇本結算

```csharp
// 結算獎勵類型
public class SeasonReward
{
    public int Rank;              // 排名
    public RewardType Type;       // 獎勵類型
    public List<Item> Items;      // 獎勵物品
    public int Points;            // 賽季積分 (永久累積)
}

// 可繼承到新劇本的內容
- 賽季積分 (永久)
- 特定英雄/將領
- 稀有道具
- 成就稱號
- 外觀裝飾

// 每個劇本重置的內容
- 城池歸屬
- 資源數量
- 建築等級
- 部隊數量
```

### 2.4 劇本配置

```csharp
// 劇本配置數據
public class ScenarioConfig
{
    public int ScenarioId;
    public string Name;                    // 劇本名稱 (如: "三國鼎立")
    public int MaxPlayers;                 // 最大玩家數
    public int NationCount;                // 國家數量
    public int CitiesPerNation;            // 每國初始城池數
    public List<PhaseConfig> Phases;       // 階段配置
    public MapConfig MapData;              // 地圖配置
}
```

---

## 3. 國家與城池系統

### 3.1 國家系統

```
┌─────────────────────────────────────────────────────────────┐
│                        國家結構                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  國家 (Nation)                                              │
│  ├── 國王 (由系統或玩家選舉產生)                              │
│  ├── 官職系統 (丞相、將軍、太守等)                            │
│  ├── 國家科技 (全體成員共享加成)                              │
│  ├── 國家倉庫 (共享資源池)                                   │
│  └── 所屬城池                                               │
│       ├── 主城 (首都，不可失守)                              │
│       ├── 城池A (玩家領地所在)                               │
│       ├── 城池B                                             │
│       └── ...                                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 加入國家流程

```
┌─────────────────────────────────────────────────────────────┐
│                     新玩家加入流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  新玩家進入伺服器                                            │
│          ↓                                                  │
│  選擇國家 (顯示各國人數，引導平衡)                            │
│     ╱    │    ╲                                            │
│  國家A  國家B  國家C                                         │
│     ↓    ↓    ↓                                            │
│  選擇入住城池 (該國初始4座城池)                               │
│  ┌─────┬─────┬─────┬─────┐                                 │
│  │城池1│城池2│城池3│城池4│                                  │
│  │85/100│72/100│90/100│45/100│  ← 顯示當前人數/上限          │
│  └─────┴─────┴─────┴─────┘                                 │
│          ↓                                                  │
│  進入個人領地 (私人空間)                                      │
│          ↓                                                  │
│  開始建設發展                                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 初始城池配置

```
每個國家初始城池: 4 座
每座城池容量上限: 100 人
每個國家最大玩家數: 4 × 100 = 400 人

城池選擇規則:
1. 玩家可自由選擇任一未滿城池
2. 城池滿員後無法再選擇
3. 建議優先引導至人數較少的城池
```

### 3.4 國家平衡機制

```csharp
// 防止國家人數失衡
public class NationBalancer
{
    // 人數限制
    public int MaxPlayersPerNation;

    // 動態調整
    - 人數少的國家: 獲得資源/戰鬥加成
    - 人數多的國家: 關閉新玩家加入

    // 叛逃機制 (可選)
    - 特定條件下允許更換國家
    - 叛逃有懲罰 (資源損失、冷卻期)
}
```

### 3.5 城池系統

```
┌─────────────────────────────────────────────────────────────┐
│                        城池結構                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  城池 (City) - 世界地圖上的節點                              │
│  ├── 城池等級 (初始Lv1，可升級)                              │
│  ├── 城池容量: 100 人/城                                    │
│  ├── 城池公共資金池 (玩家捐贈累積)                            │
│  ├── 城池設施 (公共建築，為入住玩家提供加成)                   │
│  │    ├── 城牆 (城池血量 + 防禦值)                           │
│  │    ├── 市場 (銅錢產出加成)                               │
│  │    ├── 農莊 (糧草產出加成)                               │
│  │    ├── 木工坊 (木材產出加成)                              │
│  │    └── 石料場 (石頭產出加成)                              │
│  ├── 太守 (城池管理者，負責升級城池設施)                       │
│  └── 居民列表 (入住該城的玩家ID清單)                          │
│                                                             │
│  ※ 城池在世界地圖上可見                                      │
│  ※ 城池被攻破時，全城玩家受影響                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.6 城池設施詳解

```
┌─────────────────────────────────────────────────────────────┐
│                      城池設施說明                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【城牆】- 城池核心防禦設施                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  功能:                                               │   │
│  │  • 決定城池總血量 (HP)                                │   │
│  │  • 決定城池防禦值                                     │   │
│  │  • 城牆血量歸零 = 城池失守                            │   │
│  │                                                      │   │
│  │  等級效果:                                            │   │
│  │  Lv1: HP 10000, 防禦 100                             │   │
│  │  Lv2: HP 15000, 防禦 150                             │   │
│  │  Lv3: HP 22000, 防禦 220                             │   │
│  │  Lv4: HP 30000, 防禦 300                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【市場】- 銅錢產出加成                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Lv1: 銅錢產出 +5%                                   │   │
│  │  Lv2: 銅錢產出 +10%                                  │   │
│  │  Lv3: 銅錢產出 +15%                                  │   │
│  │  Lv4: 銅錢產出 +20%                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【農莊】- 糧草產出加成                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Lv1: 糧草產出 +5%                                   │   │
│  │  Lv2: 糧草產出 +10%                                  │   │
│  │  Lv3: 糧草產出 +15%                                  │   │
│  │  Lv4: 糧草產出 +20%                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【木工坊】- 木材產出加成                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Lv1: 木材產出 +5%                                   │   │
│  │  Lv2: 木材產出 +10%                                  │   │
│  │  Lv3: 木材產出 +15%                                  │   │
│  │  Lv4: 木材產出 +20%                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【石料場】- 石頭產出加成                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Lv1: 石頭產出 +5%                                   │   │
│  │  Lv2: 石頭產出 +10%                                  │   │
│  │  Lv3: 石頭產出 +15%                                  │   │
│  │  Lv4: 石頭產出 +20%                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.7 城池設施升級機制

```
┌─────────────────────────────────────────────────────────────┐
│                    城池設施升級流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 入住玩家捐贈資源                                         │
│     ├── 銅錢                                                │
│     └── 糧草                                                │
│              ↓                                              │
│  2. 資源進入城池公共資金池                                    │
│              ↓                                              │
│  3. 太守選擇升級項目                                         │
│              ↓                                              │
│  4. 升級完成，全城玩家獲得加成                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘

城池設施總覽:
┌──────────┬──────────────────┬────────────────────────┐
│ 設施     │ 功能             │ 效果                   │
├──────────┼──────────────────┼────────────────────────┤
│ 城牆     │ 城池血量與防禦   │ 決定城池存亡           │
│ 市場     │ 銅錢產出加成     │ +5%/+10%/+15%/+20%     │
│ 農莊     │ 糧草產出加成     │ +5%/+10%/+15%/+20%     │
│ 木工坊   │ 木材產出加成     │ +5%/+10%/+15%/+20%     │
│ 石料場   │ 石頭產出加成     │ +5%/+10%/+15%/+20%     │
└──────────┴──────────────────┴────────────────────────┘
```

### 3.8 城池失守機制

```
┌─────────────────────────────────────────────────────────────┐
│                    城池失守處理流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  城池城牆血量歸零 → 城池被敵方攻破                            │
│          ↓                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  立即影響 (守方所有入住玩家)                          │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  1. ⚠️ 該城池內囤放的士兵【全部陣亡】                 │   │
│  │  2. 損失該城池內所有產出的 50%                        │   │
│  │  3. 失去該城池所有設施加成                            │   │
│  │  4. 無法在該城池招募士兵                              │   │
│  └─────────────────────────────────────────────────────┘   │
│          ↓                                                  │
│  玩家選擇: [留守] 或 [搬遷]                                  │
│          ↓                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  選擇搬遷至本國其他城池                               │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  搬遷規則:                                            │   │
│  │  • 領地內建築不會消失                                 │   │
│  │  • 所有建築降級 2 等 (最低降至 Lv1)                   │   │
│  │  • 完整搬遷至新城池                                   │   │
│  │  • ⚠️ 士兵已全部陣亡，需重新招募                      │   │
│  │  • 資源不變                                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ※ 若本國無其他城池可搬遷 → 國家滅亡流程                      │
│                                                             │
│  設計意圖:                                                  │
│  • 城池失守是重大損失，鼓勵玩家積極防守                       │
│  • 士兵全滅增加戰爭的緊張感和策略性                          │
│  • 需要在出征和防守間做出士兵分配的抉擇                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.9 個人領地系統 (私人空間)

```
┌─────────────────────────────────────────────────────────────┐
│                    多領地系統概念                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  玩家可同時擁有: 最多 3 個領地                                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │     [城池A]          [城池B]          [城池C]        │   │
│  │         │                │                │         │   │
│  │     領地 1            領地 2            領地 3       │   │
│  │    ┌─────┐          ┌─────┐          ┌─────┐       │   │
│  │    │農場 │          │農場 │          │兵營 │       │   │
│  │    │伐木 │          │鑄幣 │          │馬廄 │       │   │
│  │    │採石 │          │兵營 │          │射擊 │       │   │
│  │    └─────┘          └─────┘          └─────┘       │   │
│  │         │                │                │         │   │
│  │         └────────────────┼────────────────┘         │   │
│  │                          ↓                          │   │
│  │              ┌─────────────────────┐                │   │
│  │              │   共用資源池        │                │   │
│  │              │  銅錢: 10000       │                │   │
│  │              │  木材: 5000        │                │   │
│  │              │  石頭: 3000        │                │   │
│  │              │  糧草: 8000        │                │   │
│  │              └─────────────────────┘                │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  領地特點:                                                  │
│  1. 每個領地是獨立的私人空間 (不顯示在世界地圖)               │
│  2. 可在不同城池建立領地 (擴大勢力範圍)                       │
│  3. 所有領地的產出匯入同一個資源池                            │
│  4. 可在任意領地招募士兵 (受該城池加成影響)                   │
│  5. 城池失守時，該城池內的領地士兵全滅                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.10 多領地管理

```
┌─────────────────────────────────────────────────────────────┐
│                    領地建立與管理                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  建立新領地:                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 條件:                                               │   │
│  │ • 目標城池必須屬於本國                               │   │
│  │ • 目標城池未滿員 (< 100人)                          │   │
│  │ • 玩家現有領地數 < 3                                │   │
│  │ • 需支付建立費用 (銅錢 + 木材 + 石頭)                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  領地用途策略:                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 領地1 (主城): 資源生產為主                         │   │
│  │ • 領地2 (前線): 軍事建築為主，靠近戰場               │   │
│  │ • 領地3 (後勤): 醫館、學院等功能建築                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  城池失守時的領地處理:                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 該城池內的領地囤放士兵【全部陣亡】                  │   │
│  │ • 其他城池的領地不受影響                             │   │
│  │ • 失守城池的領地可選擇:                              │   │
│  │   - 留守 (失去加成，無法招募)                        │   │
│  │   - 搬遷 (建築降2級，移至本國其他城池)               │   │
│  │   - 放棄 (返還部分資源)                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.11 領地數據結構

```csharp
// 玩家可擁有多個領地
public class PlayerTerritories
{
    public long PlayerId;
    public const int MaxTerritories = 3;  // 最多3個領地
    public List<Territory> Territories;   // 領地列表
}

// 單個領地
public class Territory
{
    public int TerritoryId;
    public long PlayerId;
    public int CityId;              // 所屬城池
    public int TerritoryLevel;      // 領地等級

    // 領地結構
    public Building Mansion;        // 府邸 (預設，不可移除)
    public const int MaxBuildingSlots = 20;  // 20個空建築位
    public List<Building> Buildings; // 私人建築 (最多20個)

    public int StationedSoldiers;   // 該領地囤放的士兵數

    // 領地不在世界地圖渲染
    // 玩家通過 UI 切換不同領地
}

// 領地建築類型
public enum TerritoryBuildingType
{
    // 核心建築
    Mansion,        // 府邸 - 領地核心 (預設，不可拆除)

    // 資源類
    Farm,           // 農場 - 產糧草
    LumberMill,     // 伐木場 - 產木材
    Quarry,         // 採石場 - 產石頭
    Mint,           // 鑄幣坊 - 產銅錢

    // 軍事類
    Barracks,       // 兵營 - 訓練步兵 (槍兵、盾兵)
    Stable,         // 馬廄 - 訓練騎兵
    ArcheryRange,   // 射擊場 - 訓練弓兵

    // 功能類
    Academy,        // 學院 - 科技研究
    Hospital        // 醫館 - 傷兵恢復
}
```

### 3.12 領地結構與建築配置

```
┌─────────────────────────────────────────────────────────────┐
│                      領地結構示意                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  每個領地預設:                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [府邸] + [空位×20]                                   │   │
│  │     ↓                                               │   │
│  │  府邸: 領地核心建築，不可拆除                          │   │
│  │  空位: 可自由建設任意設施                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  建築配置範例:                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │   [府邸]                                             │   │
│  │                                                      │   │
│  │   [農場][農場][農場][農場][伐木][伐木][採石][鑄幣]     │   │
│  │   [兵營][兵營][兵營][馬廄][馬廄][射擊][射擊][醫館]     │   │
│  │   [學院][空位][空位][空位]                            │   │
│  │                                                      │   │
│  │   總計: 1府邸 + 17建築 + 3空位 = 21格                 │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.13 訓練設施加成機制

```
┌─────────────────────────────────────────────────────────────┐
│                    訓練速度加成系統                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  訓練設施與兵種對應:                                         │
│  ┌────────────┬─────────────────────────────────────────┐  │
│  │ 訓練設施   │ 可訓練兵種                               │  │
│  ├────────────┼─────────────────────────────────────────┤  │
│  │ 兵營       │ 槍兵、盾兵 (步兵系)                       │  │
│  │ 馬廄       │ 騎兵                                     │  │
│  │ 射擊場     │ 弓兵                                     │  │
│  └────────────┴─────────────────────────────────────────┘  │
│                                                             │
│  加成公式:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  訓練速度 = 基礎速度 × (1 + 設施數量 × 加成係數)      │   │
│  │                                                      │   │
│  │  範例 (假設加成係數 = 0.2):                          │   │
│  │  • 1個兵營: 訓練速度 ×1.2                            │   │
│  │  • 2個兵營: 訓練速度 ×1.4                            │   │
│  │  • 3個兵營: 訓練速度 ×1.6                            │   │
│  │  • 5個兵營: 訓練速度 ×2.0                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  策略考量:                                                  │
│  • 專精單一兵種: 堆疊同類設施，訓練更快                       │
│  • 均衡發展: 各類設施都有，兵種多樣但訓練較慢                  │
│  • 20個建築位有限，需權衡資源產出與軍事訓練                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```csharp
// 訓練速度計算
public class TrainingSpeedCalculator
{
    private const float SpeedBonusPerBuilding = 0.2f;  // 每個設施+20%速度

    public float GetTrainingSpeed(Territory territory, TerritoryBuildingType trainingType)
    {
        int buildingCount = territory.Buildings
            .Count(b => b.Type == trainingType);

        float speedMultiplier = 1f + (buildingCount * SpeedBonusPerBuilding);
        return speedMultiplier;
    }

    // 範例: 計算步兵訓練時間
    public float GetInfantryTrainTime(Territory territory, int baseTime)
    {
        float speed = GetTrainingSpeed(territory, TerritoryBuildingType.Barracks);
        return baseTime / speed;  // 時間 = 基礎時間 / 速度倍率
    }
}
```

### 3.14 城池與領地的關係

```
┌─────────────────────────────────────────────────────────────┐
│                   城池 vs 個人領地                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  對比項目        城池 (City)           個人領地 (Territory)   │
│  ─────────────────────────────────────────────────────────  │
│  可見性          世界地圖可見           不可見 (私人空間)      │
│  歸屬            國家所有               玩家個人所有          │
│  可被攻擊        是                     否                   │
│  容量            100人/城               1人/領地             │
│  建築            公共設施               私人建築              │
│  資源            城池共享加成           個人產出              │
│  戰爭影響        城破則失守             不直接受影響          │
│                                                             │
│  關聯:                                                      │
│  - 玩家必須「入住」某城池才能建立領地                          │
│  - 城池提供公共加成給所有入住玩家                             │
│  - 城池失守時，玩家需遷移到其他本國城池                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 核心數據結構

### 4.1 地圖節點

```csharp
public class MapNode
{
    public int NodeId;
    public string Name;
    public NodeType Type;           // 節點類型
    public int NationId;            // 所屬國家 (0=中立)
    public Vector2 Position;        // 地圖座標 (顯示用)
    public int MaxTerritories;      // 最大領地數
    public int DefenseLevel;        // 防禦等級
    public List<int> ConnectedNodes; // 連接的節點ID
}

public enum NodeType
{
    Capital,    // 主城
    City,       // 城池
    Pass,       // 關隘
    Resource,   // 資源點
    Throne      // 王城
}
```

### 4.2 國家數據

```csharp
public class Nation
{
    public int NationId;
    public string Name;
    public string Color;            // 國家顏色
    public long KingPlayerId;       // 國王玩家ID
    public List<int> OwnedCities;   // 擁有的城池
    public int TotalPlayers;        // 玩家總數
    public NationTech Tech;         // 國家科技
    public NationResource Treasury; // 國庫
}
```

### 4.3 伺服器/劇本實例

```csharp
public class GameServer
{
    public int ServerId;
    public string ServerName;
    public int ScenarioId;          // 使用的劇本
    public DateTime StartTime;      // 開服時間
    public GamePhase CurrentPhase;  // 當前階段
    public List<Nation> Nations;    // 國家列表
    public Dictionary<int, MapNode> MapNodes; // 地圖節點
}
```

### 4.4 玩家資源系統

```csharp
// 玩家資源 (所有領地共用)
public class PlayerResources
{
    public long PlayerId;

    // 四種基礎資源
    public int Copper;      // 銅錢 - 通用貨幣
    public int Wood;        // 木材 - 建築材料
    public int Stone;       // 石頭 - 建築材料
    public int Food;        // 糧草 - 士兵消耗

    // 資源上限 (可透過建築提升)
    public int MaxCopper;
    public int MaxWood;
    public int MaxStone;
    public int MaxFood;
}
```

```
┌─────────────────────────────────────────────────────────────┐
│                      資源系統設計                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  資源類型:                                                  │
│  ┌────────┬──────────────┬────────────────────────────┐    │
│  │ 資源   │ 產出建築     │ 主要用途                    │    │
│  ├────────┼──────────────┼────────────────────────────┤    │
│  │ 銅錢   │ 鑄幣坊       │ 招募士兵、升級建築、捐贈城池 │    │
│  │ 木材   │ 伐木場       │ 建築建造、升級              │    │
│  │ 石頭   │ 採石場       │ 建築建造、升級、城防        │    │
│  │ 糧草   │ 農場         │ 士兵維護、行軍消耗、捐贈城池│    │
│  └────────┴──────────────┴────────────────────────────┘    │
│                                                             │
│  資源特性:                                                  │
│  • 所有領地共用同一資源池                                    │
│  • 資源存儲有上限，超出則停止產出                            │
│  • 糧草會被士兵持續消耗                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.5 士兵系統

```csharp
// 玩家士兵
public class PlayerArmy
{
    public long PlayerId;
    public int TotalSoldiers;       // 當前士兵總數
    public const int MaxSoldiers = 5000;  // 士兵上限

    // 各兵種數量
    public int Spearman;    // 槍兵
    public int Shieldman;   // 盾兵
    public int Cavalry;     // 騎兵
    public int Archer;      // 弓兵
}
```

```
┌─────────────────────────────────────────────────────────────┐
│                      士兵系統設計                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  士兵上限: 5000 (玩家個人總計)                               │
│                                                             │
│  招募規則:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 可在任意自己的領地招募士兵                          │   │
│  │ • 招募需要: 銅錢 + 糧草                               │   │
│  │ • 城池失守後，無法在該城池招募                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  兵種類型:                                                  │
│  ┌────────┬────────┬────────┬────────┬─────────┐          │
│  │ 兵種   │ 攻擊   │ 防禦   │ 速度   │ 訓練建築 │          │
│  ├────────┼────────┼────────┼────────┼─────────┤          │
│  │ 槍兵   │ 中     │ 中     │ 中     │ 兵營     │          │
│  │ 盾兵   │ 低     │ 高     │ 慢     │ 兵營     │          │
│  │ 騎兵   │ 高     │ 中     │ 快     │ 馬廄     │          │
│  │ 弓兵   │ 高     │ 低     │ 中     │ 射擊場   │          │
│  └────────┴────────┴────────┴────────┴─────────┘          │
│                                                             │
│  兵種克制:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 槍兵 克制 騎兵 (傷害 ×1.5)                         │   │
│  │ • 騎兵 克制 盾兵 (傷害 ×1.5)                         │   │
│  │ • 弓兵 被所有兵種克制 (受傷 ×1.5)                    │   │
│  │ • 盾兵 抗弓兵傷害 (受傷 ×0.5)                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  士兵消耗:                                                  │
│  • 維護費: 每小時消耗糧草 (士兵數 × 係數)                    │
│  • 行軍消耗: 出征時額外消耗糧草                              │
│  • 糧草不足: 士兵逃亡/士氣下降                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.6 出征系統

```
┌─────────────────────────────────────────────────────────────┐
│                      出征規則                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  出征限制:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  玩家只能攻擊與本國城池「銜接」的城池                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  範例:                                                      │
│                                                             │
│      [敵城X]────[敵城Y]                                    │
│          │                                                  │
│      [關隘]  ← 可攻擊 (與我城A銜接)                         │
│          │                                                  │
│      [我城A]────[我城B]                                    │
│                                                             │
│  規則說明:                                                  │
│  1. 必須從本國城池出發                                      │
│  2. 只能攻擊相鄰（有路線連接）的敵方城池                     │
│  3. 中立城池/關隘也需要攻佔才能通過                          │
│  4. 不能「跳過」敵方城池直接攻擊後方                         │
│                                                             │
│  出征流程:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 選擇出發城池 (玩家入住的城池)                       │   │
│  │ 2. 選擇目標城池 (必須與出發城池銜接)                   │   │
│  │ 3. 編制部隊 (選擇派出的士兵數量和兵種)                 │   │
│  │ 4. 確認糧草消耗                                       │   │
│  │ 5. 出發行軍                                           │   │
│  │ 6. 抵達目標 → 觸發戰鬥                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```csharp
// 出征驗證
public class ExpeditionValidator
{
    public bool CanAttack(int fromCityId, int targetCityId, int nationId)
    {
        // 1. 確認出發城池屬於玩家所屬國家
        // 2. 確認目標城池與出發城池有路線連接
        // 3. 確認目標城池不屬於自己國家
        // 4. 確認玩家有足夠士兵和糧草

        var fromCity = GetCity(fromCityId);
        var targetCity = GetCity(targetCityId);

        // 檢查城池是否銜接
        bool isConnected = fromCity.ConnectedNodes.Contains(targetCityId);

        // 檢查目標不是自己國家
        bool isEnemy = targetCity.NationId != nationId;

        return isConnected && isEnemy;
    }
}
```

---

## 5. 遊戲流程總覽

```
┌─────────────────────────────────────────────────────────────┐
│                     玩家遊戲流程                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 選擇伺服器 (劇本)                                        │
│          ↓                                                  │
│  2. 選擇/加入國家                                            │
│          ↓                                                  │
│  3. 在分配的城池建立領地                                      │
│          ↓                                                  │
│  4. 發展期: 建設領地、招募部隊、研究科技                        │
│          ↓                                                  │
│  5. 爭霸期: 與國家成員協作，攻佔敵國城池                        │
│          ↓                                                  │
│  6. 決戰期: 爭奪王城，決定劇本勝負                             │
│          ↓                                                  │
│  7. 結算: 獲得獎勵，進入新劇本                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 與技術架構的對應

| 遊戲機制 | 技術實現 |
|---------|---------|
| 節點式地圖 | 圖結構 (Graph) + A* 尋路 |
| 路線行軍 | 服務端計算路徑，定時同步位置 |
| 劇本制 | 每個伺服器獨立數據庫/分區 |
| 國家系統 | 國家表 + 成員關係表 |
| 城池歸屬 | 狀態同步，變更時廣播 |
| 領地建設 | 玩家私有數據，低頻同步 |

---

*文檔創建日期: 2024-12-14*
*版本: 2.3 - 領地結構(府邸+20空位)、步兵共用兵營、訓練設施加成*
