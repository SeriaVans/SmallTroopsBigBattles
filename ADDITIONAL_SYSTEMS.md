# 補充系統設計文檔

> **用途**: 記錄將領、科技、任務、聊天等補充系統設計
> **最後更新**: 2024-12-14
> **版本**: 1.0

---

## 目錄

1. [將領系統](#1-將領系統)
2. [科技系統](#2-科技系統)
3. [任務系統](#3-任務系統)
4. [聊天系統](#4-聊天系統)
5. [設計修正記錄](#5-設計修正記錄)

---

## 1. 將領系統

### 1.1 系統定位

```
將領 = 士兵的指揮官 + 戰場增幅器

核心功能:
1. 帶領部隊出征（不帶將領的部隊戰力大幅下降）
2. 提供屬性加成（攻擊、防禦、速度等）
3. 技能系統（預留）
4. 收集養成要素
```

### 1.2 將領職業

| 職業 | 擅長兵種 | 定位 |
|------|----------|------|
| 統帥 (Commander) | 步兵 (槍兵、盾兵) | 均衡/防守 |
| 先鋒 (Vanguard) | 騎兵 | 進攻/突襲 |
| 軍師 (Strategist) | 弓兵 | 遠程/輔助 |

### 1.3 將領屬性

```csharp
public class General
{
    public long GeneralId;
    public string Name;
    public int Rarity;              // 稀有度: 1-5星
    public GeneralClass Class;      // 職業類型

    // 基礎屬性
    public int Level;               // 等級 (1-50)
    public int Stars;               // 升星 (1-5)

    // 四維屬性
    public float Strength;          // 武力 - 影響部隊攻擊
    public float Intelligence;      // 智力 - 影響技能效果 (預留)
    public float Command;           // 統帥 - 影響帶兵上限
    public float Speed;             // 速度 - 影響行軍/攻擊速度

    // 技能 (預留)
    public Skill MainSkill;         // 主技能
    public List<Skill> SubSkills;   // 副技能 (最多2個)

    // 帶兵
    public SoldierType[] Proficiency; // 擅長兵種
}

public enum GeneralClass
{
    Commander,      // 統帥 - 步兵加成
    Vanguard,       // 先鋒 - 騎兵加成
    Strategist      // 軍師 - 弓兵加成
}
```

### 1.4 基礎設定

| 項目 | 設定 |
|------|------|
| 等級上限 | 50 級 |
| 稀有度 | 1-5 星 |
| 稀有度影響 | 保守 (5星比1星強約 50-80%) |
| 數量限制 | 無限制 |
| 出征編制 | 1 將領 + 士兵 |
| 陣亡影響 | 無 (簡化設計) |
| 技能系統 | 預留待開發 |

### 1.5 將領加成公式

```
部隊攻擊 = 基礎攻擊 × (1 + 將領武力 × 0.01)
部隊防禦 = 基礎防禦 × (1 + 將領統帥 × 0.01)
帶兵上限 = 500 + (將領統帥 × 10)
擅長兵種額外加成: +15%

無將領懲罰: 攻擊/防禦 -30%
```

### 1.6 將領帶兵機制

```
┌─────────────────────────────────────────────────────────────┐
│                     將領帶兵機制                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    出征部隊 = 將領 + 士兵                                    │
│                                                             │
│    ┌─────────┐                                             │
│    │ 將領A   │ ← 帶兵上限: 1500                             │
│    │ (先鋒)  │                                             │
│    └────┬────┘                                             │
│         │                                                   │
│    ┌────┴────────────────────┐                            │
│    │  槍兵 500 + 騎兵 800    │  ← 實際帶兵: 1300           │
│    │  (騎兵獲得 +15% 攻擊)   │  ← 擅長兵種加成             │
│    └─────────────────────────┘                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.7 將領獲取途徑

| 途徑 | 說明 | 產出 |
|------|------|------|
| 普通招募 | 消耗銅錢 | 1-3★ 將領 |
| 高級招募 | 消耗招募令 | 3-5★ 將領 |
| 主線任務 | 章節獎勵 | 1-5★ 將領 |
| 商店兌換 | 碎片兌換 | 指定將領 |

### 1.8 將領養成系統

```
【升級】消耗: 經驗道具
Lv1 ───→ Lv25 ───→ Lv50
       (需要升星)

【升星】消耗: 相同將領 或 通用碎片
★☆☆☆☆ → ★★☆☆☆ → ★★★☆☆ → ★★★★☆ → ★★★★★
(1星)    (2星)     (3星)     (4星)     (5星)

每升一星: 屬性 +10%
```

---

## 2. 科技系統

### 2.1 雙層科技架構

```
┌─────────────────────────────────────────┐
│              科技系統                    │
└──────────────────┬──────────────────────┘
                   │
     ┌─────────────┴─────────────┐
     ↓                           ↓
┌─────────────┐           ┌─────────────┐
│  個人科技   │           │  國家科技   │
│ (玩家獨立) │           │ (全國共享) │
└─────────────┘           └─────────────┘
```

### 2.2 個人科技

#### 軍事科技

| 科技名稱 | 等級 | 效果 (每級) |
|----------|------|-------------|
| 步兵攻擊 | 1-10 | 槍兵、盾兵攻擊力 +2% |
| 步兵防禦 | 1-10 | 槍兵、盾兵防禦力 +2% |
| 步兵血量 | 1-10 | 槍兵、盾兵血量 +2% |
| 騎兵攻擊 | 1-10 | 騎兵攻擊力 +2% |
| 騎兵防禦 | 1-10 | 騎兵防禦力 +2% |
| 騎兵速度 | 1-10 | 騎兵移動速度 +1% |
| 弓兵攻擊 | 1-10 | 弓兵攻擊力 +2% |
| 弓兵防禦 | 1-10 | 弓兵防禦力 +2% |
| 弓兵射程 | 1-10 | 弓兵攻擊距離 +1% |
| 攻城強化 | 1-10 | 攻城傷害 +3% |
| 防守強化 | 1-10 | 守城時防禦 +3% |
| 行軍強化 | 1-10 | 行軍速度 +2% |

#### 經濟科技

| 科技名稱 | 等級 | 效果 (每級) |
|----------|------|-------------|
| 糧草產量 | 1-10 | 農場產量 +3% |
| 糧草儲量 | 1-10 | 糧草上限 +5% |
| 木材產量 | 1-10 | 伐木場產量 +3% |
| 石材產量 | 1-10 | 採石場產量 +3% |
| 銅錢產量 | 1-10 | 鑄幣坊產量 +3% |
| 交易效率 | 1-5 | 交易手續費 -5% |
| 資源保護 | 1-5 | 被掠奪損失 -5% |

#### 發展科技

| 科技名稱 | 等級 | 效果 (每級) |
|----------|------|-------------|
| 建築速度 | 1-10 | 建築時間 -2% |
| 建築成本 | 1-5 | 建築消耗 -3% |
| 訓練速度 | 1-10 | 士兵訓練時間 -2% |
| 訓練成本 | 1-5 | 士兵訓練消耗 -3% |
| 領地擴建 | 1-5 | 建築格數 +1 (15→20格) |
| 將領經驗 | 1-10 | 將領獲得經驗 +3% |
| 士兵上限 | 1-10 | 士兵上限 +100 (總計+1000) |

### 2.3 國家科技

```
┌─────────────────────────────────────────────────────────────┐
│                     國家科技系統                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【定位】全體國民共同研發、共享效果                          │
│                                                             │
│  【研發方式】                                               │
│  玩家捐獻 (銅錢/糧草)                                       │
│       ↓                                                    │
│  國家科技資金池                                             │
│       ↓                                                    │
│  國王/官員 選擇研發項目                                     │
│       ↓                                                    │
│  研發完成 → 全國玩家獲得加成                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 國家科技列表

| 科技名稱 | 等級 | 效果 (每級) |
|----------|------|-------------|
| 城牆強化 | 1-10 | 全國城池城牆血量 +3% |
| 守城加成 | 1-10 | 守城戰防禦 +2% |
| 稅收減免 | 1-5 | 城池捐獻需求 -5% |
| 產量加成 | 1-10 | 全國資源產量 +1% |
| 徵兵效率 | 1-10 | 全國訓練速度 +2% |
| 訓練加成 | 1-10 | 全國士兵基礎屬性 +1% |

#### 捐獻機制

```
每日捐獻上限: 依玩家等級決定

捐獻獎勵:
• 獲得「貢獻點數」
• 貢獻點數可兌換國家商店道具
• 累積貢獻影響官職晉升

研發決策權:
• 國王: 可直接選擇研發項目
• 官員: 可提議 (需國王批准)
• 平民: 只能捐獻
```

### 2.4 科技研究機制

```
【研究條件】
1. 前置科技達到要求等級
2. 學院建築達到要求等級
3. 消耗資源 (銅錢 + 糧草)
4. 研究時間 (可用道具加速)

【研究佇列】
• 同時只能研究 1 項科技
• 無 VIP 加成 (保持公平)

【研究時間範例】
┌──────────────┬──────────────────────────────────────┐
│ 科技等級     │ 基礎研究時間                          │
├──────────────┼──────────────────────────────────────┤
│ Lv 1        │ 5 分鐘                                │
│ Lv 2        │ 15 分鐘                               │
│ Lv 3        │ 30 分鐘                               │
│ Lv 4        │ 1 小時                                │
│ Lv 5        │ 2 小時                                │
│ Lv 6-10     │ 遞增 (最高 24 小時)                   │
└──────────────┴──────────────────────────────────────┘
```

### 2.5 數據結構

```csharp
public enum TechCategory
{
    Military,   // 軍事
    Economy,    // 經濟
    Development // 發展
}

public class TechDefinition
{
    public int TechId;
    public string Name;
    public TechCategory Category;
    public int MaxLevel;
    public List<TechPrerequisite> Prerequisites;
    public List<TechEffect> Effects;
    public List<TechCost> LevelCosts;
}

public class PlayerTechProgress
{
    public long PlayerId;
    public Dictionary<int, int> TechLevels;  // TechId -> Level
    public int? CurrentResearchId;
    public DateTime? ResearchEndTime;
}

public class NationTechProgress
{
    public int NationId;
    public Dictionary<int, int> TechLevels;
    public long TechFund;                    // 科技資金池
    public int? CurrentResearchId;
    public DateTime? ResearchEndTime;
}
```

---

## 3. 任務系統

### 3.1 任務分類

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  主線任務   │    │  每日任務   │    │  成就系統   │
│ (新手引導) │    │ (日常活躍) │    │ (長期目標) │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 3.2 主線任務

```
第一章: 初入亂世
┌─────────────────────────────────────────────────────┐
│ 1-1 選擇國家並入住城池          獎勵: 銅錢 500      │
│ 1-2 建造第一座農場              獎勵: 糧草 200      │
│ 1-3 建造第一座伐木場            獎勵: 木材 200      │
│ 1-4 升級府邸至 Lv2              獎勵: 銅錢 800      │
│ 1-5 建造兵營                    獎勵: 1★將領×1     │
└─────────────────────────────────────────────────────┘

第二章: 招兵買馬
┌─────────────────────────────────────────────────────┐
│ 2-1 招募 100 名士兵             獎勵: 糧草 500      │
│ 2-2 獲得一名將領                獎勵: 經驗道具×5    │
│ 2-3 將領升至 Lv5                獎勵: 2★將領×1     │
│ 2-4 擁有 500 名士兵             獎勵: 銅錢 2000     │
│ 2-5 編組出征部隊                獎勵: 招募令×1      │
└─────────────────────────────────────────────────────┘

第三章: 開疆拓土
┌─────────────────────────────────────────────────────┐
│ 3-1 參與一場戰鬥                獎勵: 銅錢 1000     │
│ 3-2 在戰場擊殺 100 敵軍         獎勵: 經驗道具×10   │
│ 3-3 參與攻城戰                  獎勵: 3★將領×1     │
│ 3-4 建立第二個領地              獎勵: 資源禮包      │
│ 3-5 府邸升至 Lv5                獎勵: 招募令×3      │
└─────────────────────────────────────────────────────┘

第四章: 強國之路
┌─────────────────────────────────────────────────────┐
│ 4-1 研究第一項科技              獎勵: 銅錢 3000     │
│ 4-2 向城池捐獻資源              獎勵: 貢獻點 100    │
│ 4-3 擁有 2000 名士兵            獎勵: 4★將領×1     │
│ 4-4 將領升至 Lv20               獎勵: 升星材料      │
│ 4-5 參與國戰                    獎勵: 資源禮包      │
└─────────────────────────────────────────────────────┘

第五章: 霸業之巔
┌─────────────────────────────────────────────────────┐
│ 5-1 擁有 3 個領地               獎勵: 銅錢 5000     │
│ 5-2 將領升至 Lv30               獎勵: 經驗道具×20   │
│ 5-3 擁有 5000 名士兵            獎勵: 升星材料      │
│ 5-4 參與攻破敵國城池            獎勵: 招募令×5      │
│ 5-5 完成所有主線                獎勵: 5★將領×1     │
└─────────────────────────────────────────────────────┘
```

### 3.3 每日任務

```
【重置時間】每日 00:00 (伺服器時間)

【任務列表 - 簡化版】
┌──────────────────────┬───────────┬─────────────────┐
│ 任務內容             │ 活躍點數  │ 獎勵            │
├──────────────────────┼───────────┼─────────────────┤
│ 登入遊戲             │ 20        │ 銅錢 100        │
│ 收取資源 1 次        │ 20        │ 糧草 50         │
│ 訓練士兵 50 名       │ 20        │ 經驗道具×1      │
│ 升級或建造建築 1 次  │ 20        │ 木材 100        │
│ 派遣部隊 1 次        │ 20        │ 銅錢 200        │
└──────────────────────┴───────────┴─────────────────┘

【活躍度獎勵】完成 3/5 任務即可領取最終獎勵
┌──────────────┬───────────────────────────────────────┐
│ 活躍點數     │ 獎勵                                  │
├──────────────┼───────────────────────────────────────┤
│ 20 點        │ 銅錢 300                              │
│ 40 點        │ 資源選擇箱×1                          │
│ 60 點        │ 經驗道具×3                            │
│ 80 點        │ 加速道具×1                            │
│ 100 點 (滿)  │ 招募令×1                              │
└──────────────┴───────────────────────────────────────┘
```

### 3.4 成就系統

```
【建設成就】
┌─────────────┬───────────────────────┬─────────────┐
│ 成就名稱    │ 條件                  │ 獎勵        │
├─────────────┼───────────────────────┼─────────────┤
│ 初級建築師  │ 建造 10 座建築        │ 銅錢 500    │
│ 中級建築師  │ 建造 50 座建築        │ 銅錢 2000   │
│ 高級建築師  │ 建造 100 座建築       │ 招募令×1    │
│ 建築大師    │ 擁有 Lv10 建築 5 座   │ 稀有材料    │
│ 領地開拓者  │ 擁有 3 個領地         │ 銅錢 5000   │
└─────────────┴───────────────────────┴─────────────┘

【軍事成就】
┌─────────────┬───────────────────────┬─────────────┐
│ 成就名稱    │ 條件                  │ 獎勵        │
├─────────────┼───────────────────────┼─────────────┤
│ 初級將軍    │ 擊殺敵軍 1,000        │ 經驗道具×5  │
│ 中級將軍    │ 擊殺敵軍 10,000       │ 3★將領×1   │
│ 高級將軍    │ 擊殺敵軍 100,000      │ 4★將領×1   │
│ 戰神        │ 擊殺敵軍 1,000,000    │ 5★將領×1   │
│ 攻城專家    │ 參與攻破 10 座城池    │ 稀有材料    │
│ 守城專家    │ 成功防守 10 次        │ 稀有材料    │
└─────────────┴───────────────────────┴─────────────┘

【養成成就】
┌─────────────┬───────────────────────┬─────────────┐
│ 成就名稱    │ 條件                  │ 獎勵        │
├─────────────┼───────────────────────┼─────────────┤
│ 將領收藏家  │ 擁有 10 名將領        │ 招募令×2    │
│ 名將雲集    │ 擁有 5 名 4★以上將領 │ 升星材料    │
│ 兵強馬壯    │ 擁有 5000 名士兵      │ 糧草 5000   │
│ 科技先驅    │ 研究 10 項科技        │ 銅錢 3000   │
│ 科技大師    │ 任一科技達到 Lv10     │ 稀有材料    │
└─────────────┴───────────────────────┴─────────────┘

【國家成就】
┌─────────────┬───────────────────────┬─────────────┐
│ 成就名稱    │ 條件                  │ 獎勵        │
├─────────────┼───────────────────────┼─────────────┤
│ 國家棟樑    │ 捐獻城池資源 100 次   │ 貢獻點 500  │
│ 官居要職    │ 獲得國家官職          │ 稱號 (預留) │
│ 開疆功臣    │ 參與攻佔 5 座敵國城池 │ 4★將領×1   │
└─────────────┴───────────────────────┴─────────────┘

【預留系統】
• 每週任務: 預留介面，暫不實作
• 成就稱號: 預留欄位，暫不顯示
```

### 3.5 數據結構

```csharp
public enum QuestType
{
    Main,           // 主線任務
    Daily,          // 每日任務
    Achievement     // 成就
}

public class QuestDefinition
{
    public int QuestId;
    public string Name;
    public string Description;
    public QuestType Type;
    public int Chapter;             // 主線任務章節
    public int Order;
    public QuestCondition Condition;
    public List<QuestReward> Rewards;
    public int? PrerequisiteQuestId;
}

public enum QuestConditionType
{
    // 建設類
    BuildBuilding,
    UpgradeBuilding,
    BuildingReachLevel,

    // 軍事類
    TrainSoldiers,
    OwnSoldiers,
    KillEnemies,
    JoinBattle,
    WinSiege,
    DefendCity,

    // 養成類
    OwnGenerals,
    GeneralReachLevel,
    ResearchTech,
    TechReachLevel,

    // 國家類
    DonateToCity,
    GetOfficialPosition,

    // 其他
    Login,
    CollectResource,
    DispatchTroop
}

public class PlayerQuestProgress
{
    public long PlayerId;

    // 主線進度
    public int CurrentMainChapter;
    public int CurrentMainQuest;
    public HashSet<int> CompletedMainQuests;

    // 每日任務
    public Dictionary<int, int> DailyProgress;
    public int DailyActivityPoints;
    public HashSet<int> ClaimedActivityRewards;
    public DateTime LastDailyReset;

    // 成就
    public Dictionary<int, int> AchievementProgress;
    public HashSet<int> ClaimedAchievements;
}
```

---

## 4. 聊天系統

### 4.1 頻道類型

| 頻道 | 說明 | 可見範圍 |
|------|------|----------|
| 世界頻道 | 全伺服器聊天 | 所有國家玩家 |
| 國家頻道 | 國內溝通 | 僅本國玩家 |
| 私人聊天 | 一對一私聊 | 雙方玩家 |

### 4.2 聊天介面

```
┌─────────────────────────────────────────────────────┐
│ [世界] [國家] [私聊]                          [最小化]│
├─────────────────────────────────────────────────────┤
│                                                     │
│  [系統] 國戰已開啟！                                │
│                                                     │
│  [魏] 玩家A: 有人要一起打東城嗎？                   │
│                                                     │
│  [蜀] 玩家B: 蜀國最強！                            │
│                                                     │
│  [吳] 玩家C: 求援！西關被攻擊                       │
│                                                     │
│  [魏] 玩家D: @玩家A 我跟你去                        │
│                                                     │
├─────────────────────────────────────────────────────┤
│  [輸入訊息...]                           [發送]     │
└─────────────────────────────────────────────────────┘

【顯示元素】
• 國家標籤: [魏][蜀][吳] 以顏色區分
• 玩家名稱: 可點擊查看資訊/私聊
• 系統訊息: 特殊顏色標示
• @提及: 高亮顯示被提及的玩家
```

### 4.3 發言限制

| 頻道 | 發言間隔 | 說明 |
|------|----------|------|
| 世界頻道 | 10 秒 | 防刷屏 |
| 國家頻道 | 5 秒 | |
| 私人聊天 | 3 秒 | |

訊息長度上限: 100 字

### 4.4 功能列表

```
【快捷功能】
• 座標分享: 點擊分享城池座標，其他人可點擊跳轉
• @玩家: 輸入 @ 彈出玩家列表選擇
• 點擊玩家名: 查看資訊 / 私聊 / 加好友

【系統公告】自動發送到聊天頻道
• 城池被攻破: 「[系統] ○○城已被△國攻佔！」
• 國戰開啟: 「[系統] 爭霸期開始，國戰開啟！」
• 王城爭奪: 「[系統] 王城爭奪戰即將開始！」

【屏蔽/舉報】
• 屏蔽玩家: 不再顯示該玩家訊息
• 舉報玩家: 提交不當言論舉報
• 禁言機制: 違規玩家由系統/GM 禁言
```

### 4.5 私聊與好友

```
【私聊】
• 點擊玩家名稱 → 「發送私聊」
• 最近聊天列表顯示最近 20 位對話對象
• 離線訊息: 保留 7 天內的未讀訊息
• 可跨國私聊 (方便外交談判)

【好友系統】(簡化版)
• 好友上限: 50 人
• 添加好友: 發送申請，對方同意後成為好友
• 好友列表: 顯示在線狀態
• 好友功能: 快速私聊、查看資訊
• 刪除好友: 單方面刪除，雙方都會移除
```

### 4.6 預留功能

- 表情/貼圖系統: 預留介面
- 城池頻道細分: 暫不實作
- 語音聊天: 暫不考慮

### 4.7 數據結構

```csharp
public class ChatMessage
{
    public long MessageId;
    public ChatChannel Channel;
    public long SenderId;
    public string SenderName;
    public int SenderNationId;
    public string Content;
    public DateTime SendTime;
    public long? ReceiverId;        // 私聊專用
    public ChatAttachment Attachment;
}

public enum ChatChannel
{
    World,      // 世界頻道
    Nation,     // 國家頻道
    Private     // 私聊
}

public class ChatAttachment
{
    public AttachmentType Type;
    public int? CityId;
    public string DisplayText;
}

public enum AttachmentType
{
    None,
    CityLocation    // 城池座標
}

public class Friendship
{
    public long PlayerId;
    public long FriendId;
    public DateTime CreateTime;
}

public class PlayerChatSettings
{
    public long PlayerId;
    public HashSet<long> BlockedPlayers;
    public bool WorldChatEnabled;
    public DateTime? MutedUntil;
}
```

### 4.8 技術實現

```
【通訊協議】
• 使用 WebSocket 長連接
• 訊息即時推送

【訊息存儲】
• 世界/國家頻道: 只保留最近 200 條 (Redis 緩存)
• 私聊訊息: 保留 7 天 (資料庫)
• 系統公告: 保留 3 天

【敏感詞過濾】
• 伺服器端過濾敏感詞
• 替換為 *** 或拒絕發送
```

---

## 5. 設計修正記錄

### 5.1 領地系統修正

| 項目 | 原設計 | 修正後 |
|------|--------|--------|
| 基礎建築格數 | 20 格 | 15 格 |
| 最大建築格數 | 25 格 | 20 格 (科技+5) |

### 5.2 取消的系統

| 系統 | 原因 |
|------|------|
| 聯盟/公會系統 | 已有國家系統，簡化社交結構 |
| VIP 研究佇列 | 避免 Pay to Win |

### 5.3 預留系統

| 系統 | 狀態 |
|------|------|
| 將領技能 | 預留待開發 |
| 每週任務 | 預留介面 |
| 成就稱號 | 預留欄位 |
| 聊天表情 | 預留介面 |

---

## 相關文件索引

| 文件 | 內容 |
|------|------|
| `PROJECT_SUMMARY.md` | 完整設計摘要 |
| `GAME_DESIGN.md` | 核心玩法設計 |
| `BATTLE_SYSTEM.md` | 戰鬥系統設計 |
| `TECHNICAL_ARCHITECTURE.md` | 技術架構設計 |
| `ADDITIONAL_SYSTEMS.md` | 本文件 - 補充系統設計 |

---

*文檔創建日期: 2024-12-14*
*版本: 1.0*
