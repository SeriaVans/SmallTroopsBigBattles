# Unity 線上多人 SLG 遊戲 - 完整設計文件

> **用途**: 此文件為完整的遊戲設計規格書，供後續開發或 AI 對話時參考使用。
> **最後更新**: 2024-12-14
> **版本**: 1.0

---

## 目錄

1. [專案概述](#1-專案概述)
2. [技術規格](#2-技術規格)
3. [世界觀與劇本系統](#3-世界觀與劇本系統)
4. [地圖與節點系統](#4-地圖與節點系統)
5. [國家與城池系統](#5-國家與城池系統)
6. [玩家與領地系統](#6-玩家與領地系統)
7. [資源系統](#7-資源系統)
8. [建築系統](#8-建築系統)
9. [兵種與軍隊系統](#9-兵種與軍隊系統)
10. [戰鬥系統](#10-戰鬥系統)
11. [數據結構定義](#11-數據結構定義)
12. [待開發項目](#12-待開發項目)
13. [相關文件索引](#13-相關文件索引)

---

## 1. 專案概述

### 1.1 遊戲類型
- **類型**: 線上多人策略遊戲 (SLG - Simulation Game)
- **核心玩法**: 國家對抗、城池攻防、資源經營、軍隊養成
- **特色**: 劇本制賽季、節點式地圖、大規模即時自動戰鬥

### 1.2 基礎規格

| 項目 | 規格 |
|------|------|
| 視角 | 2D (橫版/俯視混合) |
| 戰鬥模式 | 即時制自動戰鬥 |
| 目標平台 | Mobile (iOS / Android) |
| 引擎 | Unity 6.3 LTS |
| 渲染管線 | URP (Universal Render Pipeline) |
| 網路模式 | 權威伺服器 (Authoritative Server) |
| 同步策略 | 狀態同步 + 快照插值 |

### 1.3 核心循環

```
玩家加入劇本(伺服器)
        ↓
    選擇國家
        ↓
    入住城池 → 建立領地
        ↓
┌───────────────────────┐
│   核心遊戲循環        │
│                       │
│  建設領地 → 生產資源  │
│      ↓         ↓      │
│  訓練士兵 ← 消耗資源  │
│      ↓               │
│  參與國戰 → 攻城掠地  │
│      ↓               │
│  擴張領土 → 更多資源  │
│      ↓               │
│   (循環)              │
└───────────────────────┘
        ↓
    劇本結算 → 新賽季
```

---

## 2. 技術規格

### 2.1 Unity 專案配置

```
Unity 版本: Unity 6.3 LTS
渲染管線: URP (Universal Render Pipeline)
腳本後端: IL2CPP (正式發布) / Mono (開發階段)
API Level: .NET Standard 2.1
目標幀率: 60 FPS (可降級至 30 FPS)
```

### 2.2 解析度策略

```
參考解析度: 1920 x 1080
縮放模式: Scale With Screen Size
Match: 0.5 (Width-Height 平衡)

支援寬高比:
- 最小: 16:9 (標準手機)
- 最大: 21:9 (全面屏手機)
- 平板: 4:3 ~ 16:10
```

### 2.3 網路架構

```
┌─────────────────────────────────────────────────────────────┐
│                      網路架構                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [客戶端 A]  [客戶端 B]  [客戶端 C]                        │
│        │          │          │                              │
│        └──────────┼──────────┘                              │
│                   │                                          │
│                   ↓                                          │
│         ┌─────────────────┐                                 │
│         │   負載均衡器    │                                 │
│         └────────┬────────┘                                 │
│                  │                                           │
│     ┌────────────┼────────────┐                             │
│     ↓            ↓            ↓                             │
│ ┌───────┐  ┌───────┐  ┌───────┐                            │
│ │遊戲服1│  │遊戲服2│  │遊戲服3│  ← 每個服務器 = 一個劇本   │
│ └───┬───┘  └───┬───┘  └───┬───┘                            │
│     │          │          │                                  │
│     └──────────┼──────────┘                                 │
│                ↓                                             │
│     ┌─────────────────────┐                                 │
│     │   資料庫集群        │                                 │
│     │ PostgreSQL + Redis  │                                 │
│     └─────────────────────┘                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 同步策略

| 系統 | 同步方式 | 更新頻率 |
|------|----------|----------|
| 戰鬥場景 | 快照同步 + 插值 | 20 Hz (50ms) |
| 大地圖 | 狀態同步 | 事件驅動 |
| 玩家資料 | 請求-回應 | 按需 |
| 聊天系統 | WebSocket 推送 | 即時 |

### 2.5 戰鬥觀戰延遲

```
設計: 1-2 秒延遲觀戰

原因:
1. 伺服器有時間驗證和處理戰鬥邏輯
2. 所有客戶端看到一致的畫面
3. 減少網路抖動對觀戰體驗的影響
4. 防止即時情報傳遞作弊

實現:
- 伺服器計算完成後，廣播快照給所有觀戰者
- 客戶端接收快照後進行插值渲染
- 約 1-2 秒的緩衝區確保流暢播放
```

---

## 3. 世界觀與劇本系統

### 3.1 劇本制概念

```
劇本 (Scenario) = 一個獨立的遊戲賽季

特點:
- 每個伺服器就是一個獨立劇本
- 劇本有開始和結束
- 結束後進行結算，開啟新劇本
- 類似賽季制，玩家可以選擇加入不同劇本
```

### 3.2 劇本生命週期

```
┌─────────────────────────────────────────────────────────────┐
│                     劇本生命週期                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【開服階段】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 玩家選擇國家，入住城池                              │   │
│  │ • 建設發展期，無法跨國攻擊                            │   │
│  │ • 持續時間: 可配置 (如 3-7 天)                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  【爭霸階段】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 開放國戰，可攻擊敵國城池                            │   │
│  │ • 爭奪資源點、戰略要地                                │   │
│  │ • 持續時間: 主要遊戲階段                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  【決戰階段】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 開放王城爭奪                                        │   │
│  │ • 最終決戰                                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  【結算階段】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 統計各國戰績                                        │   │
│  │ • 發放獎勵                                            │   │
│  │ • 劇本關閉，開啟新劇本                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 地圖與節點系統

### 4.1 節點式地圖設計

```
設計決策: 採用節點式地圖，非自由移動

原因:
1. 簡化路徑計算和網路同步
2. 更清晰的戰略層次
3. 降低移動端效能需求
4. 便於控制遊戲節奏

結構:
- 地圖由多個「節點」組成
- 節點之間以「路線」連接
- 玩家/軍隊只能沿路線移動
- 只能攻擊與己方城池相鄰(銜接)的敵方節點
```

### 4.2 節點類型

| 節點類型 | 說明 | 可佔領 | 特殊功能 |
|----------|------|--------|----------|
| 主城 (Capital) | 國家首都 | 是 (困難) | 國家滅亡條件 |
| 城池 (City) | 一般城市 | 是 | 玩家可入住建立領地 |
| 關隘 (Pass) | 戰略要道 | 是 | 防禦加成高 |
| 資源點 (Resource) | 產出資源 | 是 | 額外資源產出 |
| 王城 (Throne) | 地圖中央 | 是 | 最終勝利條件 |

### 4.3 地圖拓撲範例

```
                         [王城]
                           │
              ┌────────────┼────────────┐
              │            │            │
           [關隘]       [關隘]       [關隘]
              │            │            │
         ┌────┴────┐  ┌────┴────┐  ┌────┴────┐
         │         │  │         │  │         │
      [資源]    [城池] [城池]  [資源] [城池]   [資源]
         │         │  │         │  │         │
    ┌────┴────┬────┘  │    ┌────┴──┴────┐    │
    │         │       │    │            │    │
 [城池]    [城池]  [城池] [城池]      [城池] [城池]
    │         │       │    │            │    │
    └────┬────┴───────┴────┴────────────┴────┘
         │
      [主城A]          [主城B]          [主城C]
      國家A            國家B            國家C
```

### 4.4 移動規則

```
┌─────────────────────────────────────────────────────────────┐
│                       移動規則                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【基本移動】                                               │
│  • 軍隊只能移動到相鄰節點                                   │
│  • 移動消耗時間 (依距離/地形)                               │
│  • 移動消耗糧草                                             │
│                                                             │
│  【攻擊限制】★重要★                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  玩家只能攻擊與「本國城池」銜接的敵方節點            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  範例:                                                      │
│                                                             │
│      [敵城X]────[敵城Y]                                    │
│          │                                                  │
│      [關隘]  ← 可攻擊 (與我城A銜接)                         │
│          │                                                  │
│      [我城A]────[我城B]                                    │
│                                                             │
│  說明:                                                      │
│  • 可攻擊: 關隘 (與我城A有路線連接)                         │
│  • 不可攻擊: 敵城X、敵城Y (未與我方城池銜接)                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 國家與城池系統

### 5.1 國家設定

```
每個劇本的國家數量: 可配置 (建議 3-5 國)

國家初始配置:
- 1 個主城 (Capital)
- 3 個一般城池 (City)
- 共 4 個初始城池

每個城池容量: 100 名玩家
每國初始可容納: 400 名玩家
```

### 5.2 城池結構

```
城池 = 公共空間，屬於國家所有

城池屬性:
├── 城池ID
├── 名稱
├── 所屬國家
├── 城池等級
├── 城牆 (HP + 防禦值)
├── 入住玩家列表 (最多100人)
├── 公共設施
│   ├── 城牆 (Wall) - 城池HP與防禦
│   ├── 市集 (Market) - 銅錢產出加成
│   ├── 農場 (Farm) - 糧草產出加成
│   ├── 伐木場 (LumberMill) - 木材產出加成
│   └── 採石場 (Quarry) - 石材產出加成
└── 總督 (Governor) - 管理者
```

### 5.3 城池設施升級

```
升級方式: 玩家捐獻資源

┌─────────────────────────────────────────────────────────────┐
│                     城池設施升級                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  捐獻資源:                                                  │
│  • 銅錢 + 糧草                                              │
│  • 累積到一定數量後，設施自動升級                           │
│                                                             │
│  管理權限:                                                  │
│  • 總督 (Governor): 可決定升級優先順序                      │
│  • 一般玩家: 只能捐獻資源                                   │
│                                                             │
│  設施效果:                                                  │
│  ┌──────────┬─────────────────────────────────────────┐    │
│  │ 設施     │ 效果                                     │    │
│  ├──────────┼─────────────────────────────────────────┤    │
│  │ 城牆     │ 城池HP、防禦值 (攻城戰關鍵)              │    │
│  │ 市集     │ 該城所有玩家銅錢產出 +X%                 │    │
│  │ 農場     │ 該城所有玩家糧草產出 +X%                 │    │
│  │ 伐木場   │ 該城所有玩家木材產出 +X%                 │    │
│  │ 採石場   │ 該城所有玩家石材產出 +X%                 │    │
│  └──────────┴─────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 城池失守機制

```
┌─────────────────────────────────────────────────────────────┐
│                     城池失守後果                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【立即效果】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 該城駐守的所有士兵陣亡                            │   │
│  │ 2. 資源產出 -50%                                     │   │
│  │ 3. 失去城池設施加成                                  │   │
│  │ 4. 無法在該城招募士兵                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【玩家遷移】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 失守城池的玩家必須遷移到其他本國城池               │   │
│  │ • 遷移時，個人領地建築等級 -2                        │   │
│  │ • 資源保留 (跨領地共用)                              │   │
│  │ • 士兵保留 (未駐守在該城的)                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【城池歸屬】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 城池歸屬權轉移給攻方國家                           │   │
│  │ • 攻方玩家可選擇入住該城                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 玩家與領地系統

### 6.1 領地概念

```
領地 (Territory) = 玩家的私人空間

核心設計:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  【領地特性】                                               │
│  • 不顯示於世界地圖 (私人空間)                              │
│  • 不會被敵人攻擊                                           │
│  • 玩家透過 UI 進入/切換領地                                │
│  • 最多可擁有 3 個領地                                      │
│                                                             │
│  【領地與城池的關係】                                       │
│  • 玩家必須「入住」某城池才能在該城建立領地                 │
│  • 一個城池最多容納 100 名玩家 (100 個領地)                 │
│  • 城池失守時，該城的領地需要遷移                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 多領地系統

```
┌─────────────────────────────────────────────────────────────┐
│                     多領地系統                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  玩家最多可擁有: 3 個領地                                   │
│                                                             │
│  領地分布範例:                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │   [城池A]          [城池B]          [城池C]          │   │
│  │      │                │                │             │   │
│  │   領地1            領地2            領地3            │   │
│  │   (主要)           (分城)           (前線)           │   │
│  │                                                      │   │
│  │                    玩家                              │   │
│  │                      │                               │   │
│  │          ┌──────────┼──────────┐                    │   │
│  │          ↓          ↓          ↓                    │   │
│  │       領地1      領地2      領地3                    │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  資源共用規則:                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 所有領地的資源產出匯入同一個資源池                 │   │
│  │ • 訓練、建設從共用資源池扣除                         │   │
│  │ • 不需要在領地間轉移資源                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 領地結構

```
每個領地的結構:

┌─────────────────────────────────────────────────────────────┐
│                       領地結構                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  預設配置:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [府邸] + [空建築位 × 20]                            │   │
│  │                                                      │   │
│  │  府邸 (Mansion):                                     │   │
│  │  • 領地核心建築                                      │   │
│  │  • 不可拆除                                          │   │
│  │  • 決定領地等級                                      │   │
│  │                                                      │   │
│  │  空建築位:                                           │   │
│  │  • 共 20 個                                          │   │
│  │  • 可自由建設任意設施                                │   │
│  │  • 可拆除重建                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  建築配置範例:                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │   [府邸]                                             │   │
│  │                                                      │   │
│  │   [農場][農場][農場][農場][伐木][伐木][採石][鑄幣]   │   │
│  │   [兵營][兵營][兵營][馬廄][馬廄][射擊][射擊][醫館]   │   │
│  │   [學院][空位][空位][空位]                           │   │
│  │                                                      │   │
│  │   總計: 1府邸 + 17建築 + 3空位 = 21格                │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 資源系統

### 7.1 資源類型

| 資源 | 用途 | 主要來源 |
|------|------|----------|
| 銅錢 (Copper) | 通用貨幣、招募、升級 | 鑄幣坊、市集加成 |
| 木材 (Wood) | 建築建設與升級 | 伐木場 |
| 石材 (Stone) | 建築建設與升級 | 採石場 |
| 糧草 (Food) | 士兵維護、招募、出征 | 農場 |

### 7.2 資源共用機制

```
┌─────────────────────────────────────────────────────────────┐
│                     資源共用機制                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【核心規則】                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 玩家的所有領地共用同一個資源池                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  資源流向:                                                  │
│                                                             │
│   領地1 產出 ──┐                                           │
│                ├──→ [共用資源池] ──→ 建設/訓練/維護        │
│   領地2 產出 ──┤     銅/木/石/糧                           │
│                │                                            │
│   領地3 產出 ──┘                                           │
│                                                             │
│  優點:                                                      │
│  • 簡化資源管理                                             │
│  • 不需要在領地間轉移資源                                   │
│  • 多領地 = 更多產出                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 資源產出計算

```
單一領地產出 = Σ (各資源建築產出)

玩家總產出 = Σ (所有領地產出) × 城池加成

城池加成:
• 市集等級 → 銅錢產出 +X%
• 農場等級 → 糧草產出 +X%
• 伐木場等級 → 木材產出 +X%
• 採石場等級 → 石材產出 +X%
```

---

## 8. 建築系統

### 8.1 領地建築類型

```csharp
public enum TerritoryBuildingType
{
    // 核心建築
    Mansion,        // 府邸 - 領地核心 (預設，不可拆除)

    // 資源類
    Farm,           // 農場 - 產糧草
    LumberMill,     // 伐木場 - 產木材
    Quarry,         // 採石場 - 產石頭
    Mint,           // 鑄幣坊 - 產銅錢

    // 軍事類
    Barracks,       // 兵營 - 訓練步兵 (槍兵、盾兵)
    Stable,         // 馬廄 - 訓練騎兵
    ArcheryRange,   // 射擊場 - 訓練弓兵

    // 功能類
    Academy,        // 學院 - 科技研究
    Hospital        // 醫館 - 傷兵恢復
}
```

### 8.2 訓練設施與兵種對應

| 訓練設施 | 可訓練兵種 | 說明 |
|----------|------------|------|
| 兵營 (Barracks) | 槍兵、盾兵 | 步兵系共用 |
| 馬廄 (Stable) | 騎兵 | 騎兵專用 |
| 射擊場 (ArcheryRange) | 弓兵 | 弓兵專用 |

### 8.3 訓練速度加成機制

```
┌─────────────────────────────────────────────────────────────┐
│                   訓練速度加成系統                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  核心公式:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  訓練速度 = 基礎速度 × (1 + 設施數量 × 加成係數)     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  範例 (假設加成係數 = 0.2):                                 │
│  • 1個兵營: 訓練速度 ×1.2                                   │
│  • 2個兵營: 訓練速度 ×1.4                                   │
│  • 3個兵營: 訓練速度 ×1.6                                   │
│  • 5個兵營: 訓練速度 ×2.0                                   │
│                                                             │
│  策略考量:                                                  │
│  • 專精流: 堆疊同類設施，單一兵種訓練快                     │
│  • 均衡流: 各類設施都有，兵種多樣但訓練慢                   │
│  • 20個建築位有限，需權衡資源產出與軍事訓練                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. 兵種與軍隊系統

### 9.1 兵種類型

| 兵種 | 攻擊 | 防禦 | 速度 | 訓練設施 | 特性 |
|------|------|------|------|----------|------|
| 槍兵 (Spearman) | 中 | 中 | 中 | 兵營 | 克制騎兵 |
| 盾兵 (Shieldman) | 低 | 高 | 慢 | 兵營 | 抗弓兵傷害 |
| 騎兵 (Cavalry) | 高 | 中 | 快 | 馬廄 | 克制盾兵 |
| 弓兵 (Archer) | 高 | 低 | 中 | 射擊場 | 遠程攻擊 |

### 9.2 兵種克制關係

```
┌─────────────────────────────────────────────────────────────┐
│                     兵種克制關係                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  克制圖:                                                    │
│                                                             │
│          ┌─────────┐                                       │
│          │  弓兵   │ ← 被所有兵種克制 (受傷 ×1.5)          │
│          └────┬────┘                                       │
│               │ (盾兵對弓兵傷害抗性 ×0.5)                   │
│               ↓                                             │
│          ┌─────────┐                                       │
│     ┌───→│  盾兵   │                                       │
│     │    └─────────┘                                       │
│     │ ×1.5                                                  │
│     │                                                       │
│  ┌──┴──────┐         ┌─────────┐                          │
│  │  騎兵   │←── ×1.5 ──│  槍兵   │                          │
│  └─────────┘         └─────────┘                          │
│                                                             │
│  克制規則:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 槍兵 攻擊 騎兵: 傷害 ×1.5                          │   │
│  │ • 騎兵 攻擊 盾兵: 傷害 ×1.5                          │   │
│  │ • 所有兵種 攻擊 弓兵: 傷害 ×1.5                      │   │
│  │ • 弓兵 攻擊 盾兵: 傷害 ×0.5 (盾兵抗性)               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 玩家軍隊

```
┌─────────────────────────────────────────────────────────────┐
│                     玩家軍隊系統                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  士兵上限: 5000                                             │
│                                                             │
│  軍隊結構:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │   玩家軍隊 (總計 5000 上限)                          │   │
│  │   ├── 槍兵: XXX                                      │   │
│  │   ├── 盾兵: XXX                                      │   │
│  │   ├── 騎兵: XXX                                      │   │
│  │   └── 弓兵: XXX                                      │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  士兵消耗:                                                  │
│  • 維護費: 每小時消耗糧草 (士兵數 × 係數)                   │
│  • 行軍消耗: 出征時額外消耗糧草                             │
│  • 糧草不足: 士兵逃亡/士氣下降                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 10. 戰鬥系統

### 10.1 戰鬥概述

```
戰鬥類型: 即時自動戰鬥 (Auto-Battle)
操控方式: 玩家派兵後自動戰鬥，僅能觀看
戰場視角: 橫版 2D，可拖動查看
參戰規模: 支援大規模多人
同步方式: 延遲觀戰 (1-2秒)
```

### 10.2 戰場佈局

```
┌─────────────────────────────────────────────────────────────────────┐
│                           戰場地圖                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                      【第三方預留區域】                              │
│                    ┌─────────────────┐                             │
│                    │   國家C 入口    │                              │
│                    │   (預留空間)    │                              │
│                    └────────┬────────┘                             │
│                             │                                       │
│  ┌──────────────────────────┼──────────────────────────┐           │
│  │                          ↓                          │           │
│  │  ┌─────────┐                           ┌─────────┐  │           │
│  │  │ 國家A   │                           │ 國家B   │  │           │
│  │  │ 出生點  │      【 戰 鬥 區 域 】     │ 出生點  │  │           │
│  │  │         │                           │         │  │           │
│  │  │ ← 入口  │                           │ 入口 →  │  │           │
│  │  └─────────┘                           └─────────┘  │           │
│  │                                                     │           │
│  │              士兵可自由移動的區域                    │           │
│  │                                                     │           │
│  └─────────────────────────────────────────────────────┘           │
│                                                                     │
│  地圖尺寸: 約 3000 x 2000 像素 (可拖動查看)                          │
│  視野範圍: 約 1920 x 1080 (一個螢幕)                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.3 戰場士兵上限與士兵池

```
┌─────────────────────────────────────────────────────────────────────┐
│                    戰場士兵上限與士兵池                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【核心規則】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 每個國家在戰場上最多同時存在 1000 名士兵                     │ │
│  │ • 超出 1000 的士兵進入「士兵池」等待                           │ │
│  │ • 戰場士兵減少時，士兵池自動補充                               │ │
│  │ • 玩家部隊抵達時，即時加入戰場或士兵池                         │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【士兵池機制】                                                     │
│                                                                     │
│     玩家派兵                                                        │
│         ↓                                                          │
│   ┌─────────────┐                                                  │
│   │ 部隊抵達戰場 │                                                  │
│   └──────┬──────┘                                                  │
│          ↓                                                          │
│   ┌──────────────────┐    是    ┌──────────────────┐               │
│   │ 戰場士兵 < 1000? │ ───────→ │ 直接進入戰場     │               │
│   └────────┬─────────┘          │ (從入口出生)     │               │
│            │ 否                  └──────────────────┘               │
│            ↓                                                        │
│   ┌──────────────────┐                                             │
│   │ 進入士兵池等待   │                                             │
│   │ (記錄兵種類型)   │                                             │
│   └──────────────────┘                                             │
│                                                                     │
│  【補充規則】                                                       │
│  • 順序: 先進先出 (FIFO)                                           │
│  • 頻率: 每秒檢查一次                                               │
│  • 速率: 每次最多補充 50 人                                         │
│  • 位置: 從入口區域生成                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.4 士兵 AI 行為

```
┌─────────────────────────────────────────────────────────────────────┐
│                       士兵 AI 行為邏輯                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【基礎 AI 狀態機】                                                 │
│                                                                     │
│       ┌─────────┐                                                  │
│       │  前進   │ ← 初始狀態 (向敵方方向移動)                       │
│       └────┬────┘                                                  │
│            │ 發現敵人進入攻擊範圍                                   │
│            ↓                                                        │
│       ┌─────────┐                                                  │
│       │  攻擊   │ ← 攻擊目標                                       │
│       └────┬────┘                                                  │
│            │ 目標死亡                                               │
│            ↓                                                        │
│       ┌─────────┐                                                  │
│       │ 尋找新目標│ → 有目標則攻擊，無目標則繼續前進                 │
│       └─────────┘                                                  │
│                                                                     │
│  【兵種 AI 行為】                                                   │
│  ┌────────┬─────────────────────────────────────────────────────┐ │
│  │ 兵種   │ AI 行為                                              │ │
│  ├────────┼─────────────────────────────────────────────────────┤ │
│  │ 槍兵   │ 直線前進，優先攻擊騎兵                               │ │
│  │ 盾兵   │ 直線前進，吸收傷害，優先攻擊最近敵人                 │ │
│  │ 騎兵   │ 快速前進，優先攻擊盾兵、弓兵                         │ │
│  │ 弓兵   │ 保持距離，優先攻擊血量最低的敵人                     │ │
│  └────────┴─────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.5 玩家戰場 UI

```
┌─────────────────────────────────────────────────────────────────────┐
│                      玩家戰場 UI 設計                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【我的部隊狀態面板】                                               │
│                                                                     │
│   ╔══════════════════════════════════════════════════════╗         │
│   ║              我的部隊                                 ║         │
│   ╠══════════════════════════════════════════════════════╣         │
│   ║                                                      ║         │
│   ║   【戰場中】                 【待上陣】               ║         │
│   ║   ┌────────────────┐       ┌────────────────┐       ║         │
│   ║   │ 槍兵:  120     │       │ 槍兵:   80     │       ║         │
│   ║   │ 盾兵:   85     │       │ 盾兵:   50     │       ║         │
│   ║   │ 騎兵:   60     │       │ 騎兵:   40     │       ║         │
│   ║   │ 弓兵:   45     │       │ 弓兵:   30     │       ║         │
│   ║   │ ──────────────│       │ ──────────────│       ║         │
│   ║   │ 總計:  310     │       │ 總計:  200     │       ║         │
│   ║   └────────────────┘       └────────────────┘       ║         │
│   ║                                                      ║         │
│   ╚══════════════════════════════════════════════════════╝         │
│                                                                     │
│  顯示資訊:                                                          │
│  • 戰場中: 玩家目前在戰場上存活的士兵 (分兵種顯示)                  │
│  • 待上陣: 玩家在士兵池中等待補充的士兵 (分兵種顯示)                │
│  • 即時更新                                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.6 第三方介入

```
┌─────────────────────────────────────────────────────────────────────┐
│                      第三方國家加入戰鬥                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  加入條件:                                                          │
│  • 第三國城池與戰場城池相鄰 (有路線連接)                            │
│  • 戰鬥正在進行中                                                   │
│  • 第三國玩家派遣部隊前往該城池                                     │
│                                                                     │
│  加入效果:                                                          │
│  • 第三國士兵從戰場上方入口進入                                     │
│  • 可選擇攻擊任一方 (或兩方都攻擊)                                  │
│  • 若第三國獲勝，該城池歸第三國所有                                 │
│                                                                     │
│  佈局:                                                              │
│                                                                     │
│              【國家C 區域】                                        │
│                   ↓                                                │
│            ┌─────────────┐                                         │
│            │  C軍入口    │                                         │
│            └──────┬──────┘                                         │
│                   │                                                 │
│    ┌──────────────┼──────────────┐                                 │
│    │              ↓              │                                 │
│ 【國家A】 ←──  戰鬥區域  ──→ 【國家B】                             │
│    └─────────────────────────────┘                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 11. 數據結構定義

### 11.1 玩家相關

```csharp
// 玩家資料
public class Player
{
    public long PlayerId;
    public string Name;
    public int NationId;
    public int Level;
    public DateTime JoinTime;
}

// 玩家資源池 (跨領地共用)
public class PlayerResources
{
    public long PlayerId;
    public int Copper;      // 銅錢
    public int Wood;        // 木材
    public int Stone;       // 石材
    public int Food;        // 糧草
}

// 玩家軍隊
public class PlayerArmy
{
    public long PlayerId;
    public int TotalSoldiers;       // 當前士兵總數
    public const int MaxSoldiers = 5000;  // 士兵上限

    // 各兵種數量
    public int Spearman;    // 槍兵
    public int Shieldman;   // 盾兵
    public int Cavalry;     // 騎兵
    public int Archer;      // 弓兵
}

// 玩家可擁有多個領地
public class PlayerTerritories
{
    public long PlayerId;
    public const int MaxTerritories = 3;  // 最多3個領地
    public List<Territory> Territories;   // 領地列表
}
```

### 11.2 領地相關

```csharp
// 單個領地
public class Territory
{
    public int TerritoryId;
    public long PlayerId;
    public int CityId;              // 所屬城池
    public int TerritoryLevel;      // 領地等級

    // 領地結構
    public Building Mansion;        // 府邸 (預設，不可移除)
    public const int MaxBuildingSlots = 20;  // 20個空建築位
    public List<Building> Buildings; // 私人建築 (最多20個)

    public int StationedSoldiers;   // 該領地囤放的士兵數
}

// 領地建築類型
public enum TerritoryBuildingType
{
    // 核心建築
    Mansion,        // 府邸 - 領地核心 (預設，不可拆除)

    // 資源類
    Farm,           // 農場 - 產糧草
    LumberMill,     // 伐木場 - 產木材
    Quarry,         // 採石場 - 產石頭
    Mint,           // 鑄幣坊 - 產銅錢

    // 軍事類
    Barracks,       // 兵營 - 訓練步兵 (槍兵、盾兵)
    Stable,         // 馬廄 - 訓練騎兵
    ArcheryRange,   // 射擊場 - 訓練弓兵

    // 功能類
    Academy,        // 學院 - 科技研究
    Hospital        // 醫館 - 傷兵恢復
}

// 訓練速度計算
public class TrainingSpeedCalculator
{
    private const float SpeedBonusPerBuilding = 0.2f;  // 每個設施+20%速度

    public float GetTrainingSpeed(Territory territory, TerritoryBuildingType trainingType)
    {
        int buildingCount = territory.Buildings
            .Count(b => b.Type == trainingType);

        float speedMultiplier = 1f + (buildingCount * SpeedBonusPerBuilding);
        return speedMultiplier;
    }
}
```

### 11.3 城池與節點相關

```csharp
// 地圖節點
public class MapNode
{
    public int NodeId;
    public string Name;
    public NodeType Type;           // 節點類型
    public int NationId;            // 所屬國家 (0=中立)
    public Vector2 Position;        // 地圖座標 (顯示用)
    public int MaxTerritories;      // 最大領地數
    public int DefenseLevel;        // 防禦等級
    public List<int> ConnectedNodes; // 連接的節點ID
}

public enum NodeType
{
    Capital,    // 主城
    City,       // 城池
    Pass,       // 關隘
    Resource,   // 資源點
    Throne      // 王城
}

// 城池
public class City
{
    public int CityId;
    public string Name;
    public int NationId;
    public int CityLevel;
    public int WallHp;              // 城牆血量
    public int WallDefense;         // 城牆防禦
    public List<CityFacility> Facilities;  // 公共設施
    public List<long> ResidentPlayers;     // 入住玩家 (最多100)
    public long GovernorId;         // 總督玩家ID
}
```

### 11.4 戰鬥相關

```csharp
// 士兵類型
public enum SoldierType
{
    Spearman,   // 槍兵 - 克制騎兵
    Shieldman,  // 盾兵 - 抗弓兵傷害
    Cavalry,    // 騎兵 - 克制盾兵
    Archer      // 弓兵 - 遠程，被所有人克制
}

// 士兵狀態
public enum SoldierState
{
    Advancing,  // 前進中 (初始狀態)
    Moving,     // 移動中 (追擊目標)
    Attacking,  // 攻擊中
    Dead        // 死亡
}

// 士兵池數據結構
public class BattlefieldSoldierPool
{
    public int NationId;
    public const int MaxOnField = 1000;  // 戰場上限

    // 按順序儲存等待的士兵 (FIFO)
    public Queue<PooledSoldier> WaitingQueue;

    // 快速查詢各兵種數量
    public int SpearmanCount;
    public int ShieldmanCount;
    public int CavalryCount;
    public int ArcherCount;

    public int TotalWaiting => WaitingQueue.Count;
}

// 等待中的士兵
public class PooledSoldier
{
    public long PlayerId;           // 所屬玩家
    public SoldierType Type;        // 兵種類型
    public DateTime JoinTime;       // 加入士兵池的時間
}

// 玩家戰場士兵狀態 (UI顯示用)
public class PlayerBattleStatus
{
    public long PlayerId;
    public int NationId;

    // 戰場上的士兵 (按兵種分類)
    public Dictionary<SoldierType, int> OnFieldSoldiers;

    // 待上陣的士兵 (在士兵池中)
    public Dictionary<SoldierType, int> WaitingSoldiers;

    public int TotalOnField => OnFieldSoldiers.Values.Sum();
    public int TotalWaiting => WaitingSoldiers.Values.Sum();
}
```

---

## 12. 待開發項目

### 12.1 系統設計 (待討論)

| 優先級 | 系統 | 狀態 | 說明 |
|--------|------|------|------|
| 高 | 英雄/將領系統 | ⏳ 待設計 | 將領帶兵、技能、屬性加成 |
| 高 | 科技樹 | ⏳ 待設計 | 研究解鎖、數值提升 |
| 中 | 聯盟/公會系統 | ⏳ 待設計 | 玩家組織、聯盟戰 |
| 中 | 任務系統 | ⏳ 待設計 | 新手引導、日常任務 |
| 中 | 聊天系統 | ⏳ 待設計 | 國家頻道、私聊 |
| 低 | 商城系統 | ⏳ 待設計 | 道具、VIP |
| 低 | 排行榜 | ⏳ 待設計 | 戰力、殺敵、貢獻 |

### 12.2 數值設計 (待平衡)

| 項目 | 狀態 | 說明 |
|------|------|------|
| 兵種詳細數值 | ⏳ 待平衡 | HP、攻擊、防禦、攻速 |
| 克制傷害倍率 | ⏳ 待平衡 | 目前設定 ×1.5 / ×0.5 |
| 資源產出速率 | ⏳ 待平衡 | 每建築每小時產出 |
| 士兵訓練時間 | ⏳ 待平衡 | 基礎時間、加成公式 |
| 建築升級成本 | ⏳ 待平衡 | 各等級資源需求 |
| 士兵維護費 | ⏳ 待平衡 | 糧草消耗公式 |

### 12.3 開發里程碑 (建議)

```
Phase 1: 原型驗證
├── Unity 專案建立
├── 基礎網路框架
├── 地圖節點系統原型
└── 簡單戰鬥測試

Phase 2: 核心系統
├── 玩家/領地系統
├── 資源/建築系統
├── 士兵訓練系統
└── 完整戰鬥系統

Phase 3: 社交與運營
├── 國家/城池系統
├── 聯盟系統
├── 聊天系統
└── 任務系統

Phase 4: 優化與測試
├── 性能優化
├── 平衡調整
├── 封測
└── 正式上線
```

---

## 13. 相關文件索引

| 文件 | 內容 | 版本 |
|------|------|------|
| `GAME_DEVELOPMENT_PLAN.md` | 開發規劃總覽、技術選型 | - |
| `TECHNICAL_ARCHITECTURE.md` | Unity 配置、網路架構、同步策略 | - |
| `GAME_DESIGN.md` | 核心玩法詳細設計 | v2.3 |
| `BATTLE_SYSTEM.md` | 戰鬥系統完整設計 | v1.2 |
| `PROJECT_SUMMARY.md` | 本文件 - 完整設計摘要 | v1.0 |

---

## 附錄: 設計決策記錄

### A. 為什麼選擇節點式地圖?
- 簡化移動和戰鬥的網路同步
- 更清晰的戰略層次
- 降低移動端效能需求
- 便於控制遊戲節奏

### B. 為什麼領地不顯示在地圖上?
- 保護玩家私人空間，不被敵人騷擾
- 簡化世界地圖，只顯示戰略要點
- 領地是內政系統，城池是外交/戰爭系統

### C. 為什麼戰場有 1000 人上限?
- 確保移動端效能
- 保持戰場畫面可讀性
- 士兵池機制保持援軍持續性
- 避免一方人數壓制

### D. 為什麼採用延遲觀戰?
- 伺服器有時間驗證戰鬥邏輯
- 所有玩家看到一致的戰鬥過程
- 減少網路抖動影響
- 防止即時情報作弊

---

*文檔結束*
*最後更新: 2024-12-14*
*版本: 1.0*
