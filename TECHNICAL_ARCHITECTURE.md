# 技術架構設計文檔

## 遊戲規格確認

| 項目 | 選擇 |
|------|------|
| **視角** | 2D |
| **戰鬥模式** | 即時制 |
| **目標平台** | Mobile (iOS / Android) |

---

## 1. Unity 項目配置

### 基礎設置
```
Unity 版本: Unity 6.3 LTS
渲染管線: URP (Universal Render Pipeline)
腳本後端: IL2CPP (正式發布)
API Level: .NET Standard 2.1
```

### Unity 6 新特性優勢
```
1. GPU Resident Drawer - 自動 GPU 實例化，提升 2D 渲染性能
2. Render Graph - 更高效的渲染管線，減少 Draw Call
3. Awaitable - 原生異步支持，可替代 UniTask
4. Multiplayer Center - 官方多人遊戲工具整合
5. 改進的 UI Toolkit - 更適合移動端 UI 開發
6. Memory Profiler 增強 - 更好的內存分析工具
7. Adaptive Performance 5.0 - 移動端性能自適應
```

### 推薦解析度策略
```csharp
// 基準解析度 (16:9 比例)
參考解析度: 1920 x 1080
縮放模式: Scale With Screen Size
Match: 0.5 (Width-Height 平衡)

// 支援的寬高比
最小: 16:9 (標準手機)
最大: 21:9 (全面屏手機)
平板: 4:3 ~ 16:10
```

---

## 2. 網路架構 (即時制專用)

### 同步策略比較

| 方案 | 優點 | 缺點 | 適用場景 |
|------|------|------|---------|
| **狀態同步** | 實現簡單、容錯高 | 流量較大 | SLG 大地圖 |
| **幀同步** | 流量小、精確 | 實現複雜、對延遲敏感 | MOBA/RTS |
| **混合同步** | 兼顧兩者優點 | 複雜度最高 | 大型即時SLG |

### 推薦方案：狀態同步 + 預測回滾

```
┌─────────────────────────────────────────────────────────┐
│                    網路架構圖                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   [Client A]  ←──WebSocket──→  [Gateway Server]         │
│   [Client B]  ←──WebSocket──→       ↓                   │
│   [Client C]  ←──WebSocket──→  [Game Server]            │
│                                     ↓                   │
│                              [Redis Cache]              │
│                                     ↓                   │
│                              [PostgreSQL]               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 同步頻率設計
```
大地圖視野: 1-2 次/秒 (低頻)
部隊移動: 5-10 次/秒 (中頻)
戰鬥狀態: 10-15 次/秒 (高頻)
聊天訊息: 事件驅動 (即時)
```

### 移動端網路優化
```
1. 消息壓縮 (LZ4/Snappy)
2. 差量更新 (Delta Sync)
3. 消息合併 (Batching)
4. 斷線重連 (Auto Reconnect)
5. 弱網處理 (Timeout + Retry)
```

---

## 3. 客戶端架構

### 核心框架設計

```
┌────────────────────────────────────────────────────────┐
│                    架構分層圖                           │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────────────────────────────────────────┐  │
│  │                 View Layer (UI)                  │  │
│  │    UGUI / UI Toolkit + 觸控手勢管理               │  │
│  └──────────────────────────────────────────────────┘  │
│                         ↓↑                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Controller Layer                     │  │
│  │         遊戲邏輯控制器 + 狀態機                    │  │
│  └──────────────────────────────────────────────────┘  │
│                         ↓↑                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │                Model Layer                        │  │
│  │            數據模型 + 網路同步                     │  │
│  └──────────────────────────────────────────────────┘  │
│                         ↓↑                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │               Service Layer                       │  │
│  │     網路服務 / 存儲服務 / 配置服務                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 核心 Manager 設計

```csharp
// 主要管理器列表
GameManager          // 遊戲全局控制
NetworkManager       // 網路通信管理
MapManager           // 地圖管理
CityManager          // 城市建設管理
ArmyManager          // 軍隊管理
BattleManager        // 戰鬥管理
ResourceManager      // 資源管理
UIManager            // UI管理
AudioManager         // 音效管理
ConfigManager        // 配置表管理
EventManager         // 事件中心
ObjectPoolManager    // 對象池
```

---

## 4. 2D 地圖系統設計

### 地圖技術選型

| 方案 | 優點 | 缺點 | 推薦度 |
|------|------|------|-------|
| **Tilemap** | Unity 原生、編輯方便 | 超大地圖性能差 | ⭐⭐⭐ |
| **分塊加載** | 性能好、支持超大地圖 | 實現複雜 | ⭐⭐⭐⭐⭐ |
| **GPU Instancing** | 渲染性能極佳 | 需要自研 | ⭐⭐⭐⭐ |

### 推薦：分塊 Tilemap + 動態加載

```
地圖結構:
┌─────────────────────────────────────┐
│  World Map (1000x1000 格子)         │
│  ┌─────┬─────┬─────┬─────┐         │
│  │Chunk│Chunk│Chunk│Chunk│ ...     │
│  │0,0  │1,0  │2,0  │3,0  │         │
│  ├─────┼─────┼─────┼─────┤         │
│  │Chunk│Chunk│Chunk│Chunk│ ...     │
│  │0,1  │1,1  │2,1  │3,1  │         │
│  └─────┴─────┴─────┴─────┘         │
│                                     │
│  每個 Chunk: 32x32 格子              │
│  視野範圍: 加載 3x3 = 9 個 Chunks    │
└─────────────────────────────────────┘
```

### 地圖視野管理
```csharp
// 視野範圍 (根據玩家位置動態加載)
加載範圍: 當前 Chunk ± 1 (共 9 個 Chunk)
預加載: 移動方向的 Chunk 優先加載
卸載: 超出範圍 2 個 Chunk 距離後卸載
```

---

## 5. 即時戰鬥系統

### 戰鬥流程

```
┌─────────────────────────────────────────────────────┐
│                   即時戰鬥流程                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [部隊相遇] → [進入戰鬥狀態] → [即時戰鬥演算]        │
│                                    ↓                │
│                            [同步戰鬥狀態]            │
│                            (位置/血量/技能)          │
│                                    ↓                │
│                            [戰鬥結算]               │
│                            (勝負/獎勵/損失)          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 戰鬥同步方案

```csharp
// 服務端權威 + 客戶端預測
1. 客戶端發送指令 (移動/攻擊/技能)
2. 客戶端立即執行預測動作
3. 服務端驗證並計算結果
4. 服務端廣播權威狀態
5. 客戶端校正差異 (插值平滑)
```

### 戰鬥數據結構
```csharp
// 部隊戰鬥狀態
public class BattleUnit
{
    public long UnitId;
    public int UnitType;
    public Vector2 Position;
    public float CurrentHp;
    public float MaxHp;
    public float Attack;
    public float Defense;
    public float Speed;
    public int TargetId;
    public BattleState State;
}

// 戰鬥狀態枚舉
public enum BattleState
{
    Idle,
    Moving,
    Attacking,
    Skill,
    Dead
}
```

---

## 6. 移動端優化策略

### 性能目標
```
目標幀率: 30 FPS (穩定) / 60 FPS (流暢)
內存限制: < 500 MB (中端機型)
安裝包: < 150 MB (首包)
網路流量: < 50 KB/分鐘 (正常遊戲)
電池消耗: 中等 (長時間可玩)
```

### 渲染優化
```
1. Sprite Atlas 圖集合併
2. 動態批次處理 (Dynamic Batching)
3. 視野外物體禁用 Renderer
4. 減少 Overdraw
5. 降低 UI 重繪頻率
6. LOD 簡化遠距離物體
```

### 內存優化
```
1. 對象池復用
2. 圖片壓縮 (ASTC/ETC2)
3. 及時卸載未使用資源
4. Addressables 按需加載
5. 避免頻繁 GC
```

### 觸控操作設計
```
單指點擊: 選擇目標
單指拖拽: 地圖平移
雙指縮放: 地圖縮放
長按: 打開詳情菜單
滑動: 快速導航
```

---

## 7. 推薦技術棧總結

### 客戶端
```
遊戲引擎: Unity 6.3 LTS
渲染管線: URP (with Render Graph)
網路框架: Netcode for GameObjects / Mirror
UI 框架: UI Toolkit (推薦) 或 UGUI + DoTween
異步: Awaitable (Unity 6 原生) 或 UniTask
響應式: R3 (UniRx 後繼) 可選
資源管理: Addressables
音效: Unity Audio + AudioMixer
數據序列化: MessagePack
配置表: Luban + Excel
```

### 服務端
```
語言: C# (.NET 8/9) 或 Go
框架: ASP.NET Core / Gin
通信協議: WebSocket + Protobuf/MessagePack
數據庫: PostgreSQL (持久) + Redis (緩存)
消息隊列: RabbitMQ
容器化: Docker + Kubernetes
```

---

## 8. 開發優先級

### Phase 1: 基礎可玩 (MVP)
```
□ Unity 項目搭建
□ 基礎 UI 框架
□ 2D 地圖顯示與拖拽
□ 簡單建築系統
□ 本地數據存儲
```

### Phase 2: 核心玩法
```
□ 完整地圖系統
□ 資源產出
□ 部隊創建與移動
□ 基礎即時戰鬥
□ 離線收益
```

### Phase 3: 網路聯機
```
□ 帳號系統
□ 服務端開發
□ 狀態同步
□ 多人互動
```

### Phase 4: 社交完善
```
□ 聯盟系統
□ 聊天系統
□ PvP 完善
□ 排行榜
```

---

*文檔更新日期: 2024-12-14*
*版本: 1.1 - 更新至 Unity 6.3 LTS*
