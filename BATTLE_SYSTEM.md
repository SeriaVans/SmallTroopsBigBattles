# 戰鬥系統設計文檔

## 系統概述

```
戰鬥類型: 即時自動戰鬥 (Auto-Battle)
操控方式: 玩家派兵後自動戰鬥，僅能觀看
戰場視角: 橫版 2D，可拖動查看
參戰限制: 無限制 (玩家數、士兵數)
同步方式: 延遲觀戰 (1-2秒)
```

---

## 1. 戰場佈局

### 1.1 戰場地圖結構

```
┌─────────────────────────────────────────────────────────────────────┐
│                           戰場地圖                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                      【第三方預留區域】                              │
│                    ┌─────────────────┐                             │
│                    │   國家C 入口    │                              │
│                    │   (預留空間)    │                              │
│                    └────────┬────────┘                             │
│                             │                                       │
│  ┌──────────────────────────┼──────────────────────────┐           │
│  │                          ↓                          │           │
│  │  ┌─────────┐                           ┌─────────┐  │           │
│  │  │ 國家A   │                           │ 國家B   │  │           │
│  │  │ 出生點  │      【 戰 鬥 區 域 】     │ 出生點  │  │           │
│  │  │         │                           │         │  │           │
│  │  │ ← 入口  │                           │ 入口 →  │  │           │
│  │  └─────────┘                           └─────────┘  │           │
│  │                                                     │           │
│  │              士兵可自由移動的區域                    │           │
│  │                                                     │           │
│  └─────────────────────────────────────────────────────┘           │
│                                                                     │
│  地圖尺寸: 約 3000 x 2000 像素 (可拖動查看)                          │
│  視野範圍: 約 1920 x 1080 (一個螢幕)                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 三方戰場佈局

```
當第三國加入時:

              【國家C 區域】
                   ↓
            ┌─────────────┐
            │  C軍入口    │
            │             │
            └──────┬──────┘
                   │
    ┌──────────────┼──────────────┐
    │              ↓              │
    │                             │
【國家A】 ←──  戰鬥區域  ──→ 【國家B】
    │                             │
    │                             │
    └─────────────────────────────┘

特點:
• 第三國從上方進入，與 A、B 兩國形成三角對峙
• 上方預留足夠空間，第三國不會直接接觸戰場邊緣
• 三方可互相攻擊，形成混戰局面
```

### 1.3 戰場元素

```
┌─────────────────────────────────────────────────────────────────────┐
│                         戰場元素說明                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【出生點/入口】                                                    │
│  • 每個國家有一個入口區域                                           │
│  • 新增援的士兵從入口進入戰場                                       │
│  • 入口不可被佔領或破壞                                             │
│                                                                     │
│  【城牆】(攻城戰時)                                                 │
│  • 守方城池的城牆會顯示在戰場中                                     │
│  • 城牆有血量 (對應城池城牆等級)                                    │
│  • 攻方需要先破壞城牆才能攻入                                       │
│                                                                     │
│  【地形】(可選)                                                     │
│  • 平地: 正常移動和戰鬥                                             │
│  • 高地: 弓兵有射程加成                                             │
│  • 障礙物: 阻擋移動路線                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 戰鬥觸發與流程

### 2.1 戰鬥觸發條件

```
┌─────────────────────────────────────────────────────────────────────┐
│                         戰鬥觸發                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  觸發方式:                                                          │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 1. 攻方部隊抵達目標城池                                        │ │
│  │ 2. 系統創建該城池的戰場實例                                    │ │
│  │ 3. 地圖上該城池顯示「戰爭中」標記                              │ │
│  │ 4. 參戰國所有玩家可點擊進入觀戰                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  戰場狀態:                                                          │
│  • 準備中 (等待雙方士兵就位)                                        │
│  • 戰鬥中 (自動戰鬥進行中)                                          │
│  • 結算中 (戰鬥結束，計算結果)                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 戰鬥流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         戰鬥流程                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【攻城戰流程】                                                     │
│                                                                     │
│  1. 攻方部隊抵達 → 創建戰場                                        │
│           ↓                                                        │
│  2. 守方收到通知 → 可派兵增援                                       │
│           ↓                                                        │
│  3. 戰鬥開始 (自動進行)                                             │
│           ↓                                                        │
│  4. 持續戰鬥 → 雙方可隨時增援                                       │
│           ↓                                                        │
│  5. 勝利條件達成 → 戰鬥結束                                         │
│           ↓                                                        │
│  6. 結算獎懲                                                        │
│                                                                     │
│  【勝利條件】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 攻方勝利:                                                      │ │
│  │ • 城牆血量歸零 (城池淪陷)                                      │ │
│  │                                                                │ │
│  │ 守方勝利:                                                      │ │
│  │ • 消滅所有攻方士兵                                             │ │
│  │ • 攻方撤退 (主動放棄)                                          │ │
│  │ • 戰鬥超時 (攻方未能破城)                                      │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 第三方介入

```
┌─────────────────────────────────────────────────────────────────────┐
│                      第三方國家加入戰鬥                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  加入條件:                                                          │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 第三國城池與戰場城池相鄰 (有路線連接)                        │ │
│  │ • 戰鬥正在進行中                                               │ │
│  │ • 第三國玩家派遣部隊前往該城池                                 │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  加入效果:                                                          │
│  • 第三國士兵從戰場上方入口進入                                     │
│  • 可選擇攻擊任一方 (或兩方都攻擊)                                  │
│  • 若第三國獲勝，該城池歸第三國所有                                 │
│                                                                     │
│  範例情境:                                                          │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ A國攻打B國城池                                                 │ │
│  │ C國趁機加入，同時攻擊A、B兩國                                  │ │
│  │ 最後C國獲勝，城池歸C國                                         │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.4 戰場士兵上限與補充機制

```
┌─────────────────────────────────────────────────────────────────────┐
│                    戰場士兵上限與士兵池                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【核心規則】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 每個國家在戰場上最多同時存在 1000 名士兵                     │ │
│  │ • 超出 1000 的士兵進入「士兵池」等待                           │ │
│  │ • 戰場士兵減少時，士兵池自動補充                               │ │
│  │ • 玩家部隊抵達時，即時加入戰場或士兵池                         │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【士兵池機制】                                                     │
│                                                                     │
│     玩家派兵                                                        │
│         ↓                                                          │
│   ┌─────────────┐                                                  │
│   │ 部隊抵達戰場 │                                                  │
│   └──────┬──────┘                                                  │
│          ↓                                                          │
│   ┌──────────────────┐    是    ┌──────────────────┐               │
│   │ 戰場士兵 < 1000? │ ───────→ │ 直接進入戰場     │               │
│   └────────┬─────────┘          │ (從入口出生)     │               │
│            │ 否                  └──────────────────┘               │
│            ↓                                                        │
│   ┌──────────────────┐                                             │
│   │ 進入士兵池等待   │                                             │
│   │ (記錄兵種類型)   │                                             │
│   └──────────────────┘                                             │
│                                                                     │
│  【自動補充流程】                                                   │
│                                                                     │
│   戰場士兵陣亡                                                      │
│         ↓                                                          │
│   ┌─────────────────┐                                              │
│   │ 當前人數 < 1000 │                                              │
│   └────────┬────────┘                                              │
│            ↓                                                        │
│   ┌─────────────────┐    是    ┌──────────────────┐               │
│   │ 士兵池有士兵?   │ ───────→ │ 按順序補充至1000 │               │
│   └────────┬────────┘          │ (從入口出生)     │               │
│            │ 否                 └──────────────────┘               │
│            ↓                                                        │
│   ┌──────────────────┐                                             │
│   │ 等待新援軍抵達   │                                             │
│   └──────────────────┘                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│                         士兵池詳細設計                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【士兵池結構】                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                │ │
│  │  國家A 士兵池                國家B 士兵池                      │ │
│  │  ┌─────────────────┐       ┌─────────────────┐               │ │
│  │  │ 槍兵: 500       │       │ 槍兵: 200       │               │ │
│  │  │ 盾兵: 300       │       │ 盾兵: 400       │               │ │
│  │  │ 騎兵: 200       │       │ 騎兵: 150       │               │ │
│  │  │ 弓兵: 100       │       │ 弓兵: 350       │               │ │
│  │  │ ─────────────── │       │ ─────────────── │               │ │
│  │  │ 總計: 1100      │       │ 總計: 1100      │               │ │
│  │  └─────────────────┘       └─────────────────┘               │ │
│  │                                                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【補充順序規則】                                                   │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 選項A: 先進先出 (FIFO)                                         │ │
│  │   • 最早加入士兵池的士兵優先補充                               │ │
│  │   • 公平性高，先到先戰                                         │ │
│  │                                                                │ │
│  │ 選項B: 依兵種優先級                                            │ │
│  │   • 可設定兵種補充優先順序                                     │ │
│  │   • 例: 盾兵 > 槍兵 > 騎兵 > 弓兵 (肉盾先上)                   │ │
│  │                                                                │ │
│  │ 建議: 採用 FIFO，保持公平性                                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【補充頻率】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 每 1 秒檢查一次戰場人數                                      │ │
│  │ • 每次最多補充 50 名士兵 (避免瞬間湧入)                        │ │
│  │ • 士兵從入口區域生成，逐漸加入戰場                             │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

```csharp
// 士兵池數據結構
public class BattlefieldSoldierPool
{
    public int NationId;
    public const int MaxOnField = 1000;  // 戰場上限

    // 按順序儲存等待的士兵 (FIFO)
    public Queue<PooledSoldier> WaitingQueue;

    // 快速查詢各兵種數量
    public int SpearmanCount;
    public int ShieldmanCount;
    public int CavalryCount;
    public int ArcherCount;

    public int TotalWaiting => WaitingQueue.Count;
}

// 等待中的士兵
public class PooledSoldier
{
    public long PlayerId;           // 所屬玩家
    public SoldierType Type;        // 兵種類型
    public DateTime JoinTime;       // 加入士兵池的時間
}

// 戰場管理
public class BattlefieldManager
{
    private Dictionary<int, int> _currentOnField;  // 各國戰場人數
    private Dictionary<int, BattlefieldSoldierPool> _soldierPools;

    // 當玩家部隊抵達
    public void OnTroopsArrived(long playerId, int nationId, List<SoldierType> soldiers)
    {
        int currentCount = _currentOnField[nationId];
        int availableSlots = BattlefieldSoldierPool.MaxOnField - currentCount;

        foreach (var soldier in soldiers)
        {
            if (availableSlots > 0)
            {
                // 直接加入戰場
                SpawnSoldierOnField(nationId, soldier);
                _currentOnField[nationId]++;
                availableSlots--;
            }
            else
            {
                // 加入士兵池
                AddToPool(nationId, playerId, soldier);
            }
        }
    }

    // 定時補充 (每秒調用)
    public void RefillFromPool()
    {
        foreach (var nationId in _currentOnField.Keys)
        {
            int currentCount = _currentOnField[nationId];
            int needed = BattlefieldSoldierPool.MaxOnField - currentCount;
            int toSpawn = Math.Min(needed, 50);  // 每次最多補充50人

            var pool = _soldierPools[nationId];
            for (int i = 0; i < toSpawn && pool.WaitingQueue.Count > 0; i++)
            {
                var soldier = pool.WaitingQueue.Dequeue();
                SpawnSoldierOnField(nationId, soldier.Type);
                _currentOnField[nationId]++;
            }
        }
    }
}
```

### 2.5 玩家戰場介面顯示

```
┌─────────────────────────────────────────────────────────────────────┐
│                      玩家戰場 UI 設計                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【我的部隊狀態面板】                                               │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                │ │
│  │   ╔══════════════════════════════════════════════════════╗    │ │
│  │   ║              我的部隊                                 ║    │ │
│  │   ╠══════════════════════════════════════════════════════╣    │ │
│  │   ║                                                      ║    │ │
│  │   ║   【戰場中】                 【待上陣】               ║    │ │
│  │   ║   ┌────────────────┐       ┌────────────────┐       ║    │ │
│  │   ║   │ 🔱 槍兵:  120  │       │ 🔱 槍兵:   80  │       ║    │ │
│  │   ║   │ 🛡️ 盾兵:   85  │       │ 🛡️ 盾兵:   50  │       ║    │ │
│  │   ║   │ 🐎 騎兵:   60  │       │ 🐎 騎兵:   40  │       ║    │ │
│  │   ║   │ 🏹 弓兵:   45  │       │ 🏹 弓兵:   30  │       ║    │ │
│  │   ║   │ ──────────────│       │ ──────────────│       ║    │ │
│  │   ║   │ 總計:     310  │       │ 總計:     200  │       ║    │ │
│  │   ║   └────────────────┘       └────────────────┘       ║    │ │
│  │   ║                                                      ║    │ │
│  │   ╚══════════════════════════════════════════════════════╝    │ │
│  │                                                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【完整戰場 UI 佈局】                                               │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                │ │
│  │   ┌─────────────────────────────────────────────────────┐     │ │
│  │   │ [我的部隊]              [國家總覽]         [離開] X │     │ │
│  │   ├─────────────────────────────────────────────────────┤     │ │
│  │   │                                                     │     │ │
│  │   │                                                     │     │ │
│  │   │                                                     │     │ │
│  │   │               【 戰 場 畫 面 】                      │     │ │
│  │   │                  (可拖動查看)                        │     │ │
│  │   │                                                     │     │ │
│  │   │                                                     │     │ │
│  │   │                                                     │     │ │
│  │   ├─────────────────────────────────────────────────────┤     │ │
│  │   │ 戰場中: 310    待上陣: 200    我國總兵力: 2,450     │     │ │
│  │   └─────────────────────────────────────────────────────┘     │ │
│  │                                                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【顯示說明】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 戰場中: 玩家目前在戰場上存活的士兵 (分兵種顯示)              │ │
│  │ • 待上陣: 玩家在士兵池中等待補充的士兵 (分兵種顯示)            │ │
│  │ • 數據即時更新 (隨戰鬥變化)                                    │ │
│  │ • 點擊可展開詳細面板                                           │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

```csharp
// 玩家戰場士兵狀態
public class PlayerBattleStatus
{
    public long PlayerId;
    public int NationId;

    // 戰場上的士兵 (按兵種分類)
    public Dictionary<SoldierType, int> OnFieldSoldiers;

    // 待上陣的士兵 (在士兵池中)
    public Dictionary<SoldierType, int> WaitingSoldiers;

    // 快速取得總數
    public int TotalOnField => OnFieldSoldiers.Values.Sum();
    public int TotalWaiting => WaitingSoldiers.Values.Sum();
}

// 戰場 UI 數據提供
public class BattleUIDataProvider
{
    private BattlefieldManager _battleManager;

    // 取得玩家的戰場狀態
    public PlayerBattleStatus GetPlayerStatus(long playerId)
    {
        var status = new PlayerBattleStatus
        {
            PlayerId = playerId,
            OnFieldSoldiers = new Dictionary<SoldierType, int>(),
            WaitingSoldiers = new Dictionary<SoldierType, int>()
        };

        // 統計戰場上該玩家的士兵
        foreach (var soldier in _battleManager.GetAliveSoldiers(playerId))
        {
            if (!status.OnFieldSoldiers.ContainsKey(soldier.Type))
                status.OnFieldSoldiers[soldier.Type] = 0;
            status.OnFieldSoldiers[soldier.Type]++;
        }

        // 統計士兵池中該玩家的士兵
        foreach (var pooled in _battleManager.GetPooledSoldiers(playerId))
        {
            if (!status.WaitingSoldiers.ContainsKey(pooled.Type))
                status.WaitingSoldiers[pooled.Type] = 0;
            status.WaitingSoldiers[pooled.Type]++;
        }

        return status;
    }

    // 取得國家總覽
    public NationBattleStatus GetNationStatus(int nationId)
    {
        return new NationBattleStatus
        {
            NationId = nationId,
            TotalOnField = _battleManager.GetNationOnFieldCount(nationId),
            TotalWaiting = _battleManager.GetNationPoolCount(nationId)
        };
    }
}
```

---

## 3. 自動戰鬥系統

### 3.1 士兵 AI 行為

```
┌─────────────────────────────────────────────────────────────────────┐
│                       士兵 AI 行為邏輯                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【基礎 AI 狀態機】                                                 │
│                                                                     │
│       ┌─────────┐                                                  │
│       │  前進   │ ← 初始狀態 (向敵方方向移動)                       │
│       └────┬────┘                                                  │
│            │ 發現敵人進入攻擊範圍                                   │
│            ↓                                                        │
│       ┌─────────┐                                                  │
│       │  攻擊   │ ← 攻擊目標                                       │
│       └────┬────┘                                                  │
│            │ 目標死亡                                               │
│            ↓                                                        │
│       ┌─────────┐                                                  │
│       │ 尋找新目標│ → 有目標則攻擊，無目標則繼續前進                 │
│       └─────────┘                                                  │
│                                                                     │
│  【兵種 AI 行為】                                                   │
│  ┌────────┬─────────────────────────────────────────────────────┐ │
│  │ 兵種   │ AI 行為                                              │ │
│  ├────────┼─────────────────────────────────────────────────────┤ │
│  │ 槍兵   │ 直線前進，優先攻擊騎兵                               │ │
│  │ 盾兵   │ 直線前進，吸收傷害，優先攻擊最近敵人                 │ │
│  │ 騎兵   │ 快速前進，優先攻擊盾兵、弓兵                         │ │
│  │ 弓兵   │ 保持距離，優先攻擊血量最低的敵人                     │ │
│  └────────┴─────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 戰鬥計算公式

```
┌─────────────────────────────────────────────────────────────────────┐
│                       戰鬥數值計算                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【傷害公式】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                │ │
│  │  基礎傷害 = 攻擊力 × (100 / (100 + 敵方防禦))                  │ │
│  │                                                                │ │
│  │  最終傷害 = 基礎傷害 × 兵種克制係數 × 隨機浮動(0.9~1.1)        │ │
│  │                                                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【兵種克制關係】                                                   │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                │ │
│  │              槍兵 ──克制──→ 騎兵                               │ │
│  │                              ↓                                │ │
│  │                            克制                                │ │
│  │                              ↓                                │ │
│  │                            盾兵 ──抗性──→ 弓兵                 │ │
│  │                                                                │ │
│  │  克制關係:                                                     │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │ 攻擊方    │ 防守方    │ 傷害倍率  │ 說明              │  │ │
│  │  ├────────────────────────────────────────────────────────┤  │ │
│  │  │ 槍兵      │ 騎兵      │ ×1.5     │ 槍兵克制騎兵       │  │ │
│  │  │ 騎兵      │ 盾兵      │ ×1.5     │ 騎兵克制盾兵       │  │ │
│  │  │ 任意兵種  │ 弓兵      │ ×1.5     │ 弓兵被所有人克制   │  │ │
│  │  │ 弓兵      │ 盾兵      │ ×0.5     │ 盾兵抗遠程傷害     │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  │                                                                │ │
│  │  兵種定位:                                                     │ │
│  │  • 槍兵: 反騎兵專家，中等攻防                                 │ │
│  │  • 盾兵: 肉盾坦克，高防禦，抗弓兵                             │ │
│  │  • 騎兵: 高機動突襲，克制盾兵，怕槍兵                         │ │
│  │  • 弓兵: 遠程輸出，高傷害但脆皮                               │ │
│  │                                                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【攻城傷害】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                │ │
│  │  城牆傷害 = 士兵攻擊力 × 攻城係數                              │ │
│  │                                                                │ │
│  │  攻城係數:                                                     │ │
│  │  • 槍兵: 0.5 (不擅長攻城)                                     │ │
│  │  • 盾兵: 0.3 (防守型，攻城弱)                                 │ │
│  │  • 騎兵: 0.3 (不適合攻城)                                     │ │
│  │  • 弓兵: 0.8 (可以射擊城牆守軍)                               │ │
│  │                                                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 士兵數據結構

```csharp
// 戰場上的士兵單位
public class BattleSoldier
{
    public long SoldierId;
    public long OwnerId;        // 所屬玩家
    public int NationId;        // 所屬國家
    public SoldierType Type;    // 兵種

    // 戰鬥屬性
    public float MaxHp;
    public float CurrentHp;
    public float Attack;
    public float Defense;
    public float Speed;         // 移動速度
    public float AttackRange;   // 攻擊距離
    public float AttackSpeed;   // 攻擊間隔

    // 位置狀態
    public Vector2 Position;
    public Vector2 TargetPosition;
    public long TargetId;       // 攻擊目標
    public SoldierState State;  // 當前狀態
}

public enum SoldierType
{
    Spearman,   // 槍兵 - 克制騎兵
    Shieldman,  // 盾兵 - 抗弓兵傷害
    Cavalry,    // 騎兵 - 克制盾兵
    Archer      // 弓兵 - 遠程，被所有人克制
}

public enum SoldierState
{
    Advancing,  // 前進中 (初始狀態)
    Moving,     // 移動中 (追擊目標)
    Attacking,  // 攻擊中
    Dead        // 死亡
}
```

---

## 4. 觀戰系統

### 4.1 觀戰入口

```
┌─────────────────────────────────────────────────────────────────────┐
│                         觀戰系統                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【世界地圖顯示】                                                   │
│                                                                     │
│      [城池A] ── [城池B] ── [城池C]                                 │
│                   ⚔️                                                │
│               「戰爭中」                                            │
│            點擊進入觀戰                                             │
│                                                                     │
│  【可觀戰的人】                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 參戰國家的所有玩家 (攻方、守方、第三方)                      │ │
│  │ • 同盟國家的玩家 (若有同盟系統)                                │ │
│  │ • 其他國家: 不可觀戰 (防止情報洩漏)                            │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 觀戰介面

```
┌─────────────────────────────────────────────────────────────────────┐
│                       觀戰介面設計                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  [A國: 2500兵]              vs              [B國: 1800兵]   │   │
│  │  ████████████████                      ██████████████       │   │
│  │                                                             │   │
│  │  城牆血量: ████████████░░░░ 65%                             │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │                                                             │   │
│  │                      【戰場畫面】                           │   │
│  │                                                             │   │
│  │     🔵🔵🔵         ⚔️⚔️⚔️         🔴🔴🔴                 │   │
│  │     🔵🔵        ⚔️    ⚔️        🔴🔴                     │   │
│  │     🔵🔵🔵      ⚔️⚔️           🔴🔴🔴                    │   │
│  │                                                             │   │
│  │                   (可拖動查看)                              │   │
│  │                                                             │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  [增援] [撤退] [聊天]                           [返回地圖]  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  介面元素:                                                          │
│  • 頂部: 雙方兵力統計、城牆血量                                     │
│  • 中央: 戰場畫面 (可拖動、縮放)                                    │
│  • 底部: 操作按鈕 (增援、撤退等)                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 觀戰同步機制

```
┌─────────────────────────────────────────────────────────────────────┐
│                      觀戰同步技術                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【延遲觀戰機制】                                                   │
│                                                                     │
│  服務端                        客戶端 (觀戰者)                      │
│     │                              │                                │
│     │  每 100ms 產生戰場快照       │                                │
│     ├────────────────────────────→│                                │
│     │                              │  延遲 1-2 秒播放               │
│     │                              │                                │
│     │  快照內容:                   │                                │
│     │  • 所有士兵位置              │                                │
│     │  • 血量變化                  │                                │
│     │  • 死亡事件                  │                                │
│     │  • 城牆血量                  │                                │
│     │                              │                                │
│                                                                     │
│  【優化策略】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 差量更新: 只傳輸變化的數據                                   │ │
│  │ • 合併顯示: 大量士兵合併為一個單位顯示                         │ │
│  │ • LOD: 縮小視角時簡化顯示                                      │ │
│  │ • 插值平滑: 客戶端平滑移動動畫                                 │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 增援與撤退

### 5.1 增援系統

```
┌─────────────────────────────────────────────────────────────────────┐
│                         增援機制                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【增援流程】                                                       │
│                                                                     │
│  1. 玩家在觀戰介面點擊「增援」                                      │
│           ↓                                                        │
│  2. 選擇要派出的士兵 (從領地囤兵中選擇)                             │
│           ↓                                                        │
│  3. 確認派出 (消耗糧草)                                             │
│           ↓                                                        │
│  4. 士兵從入口進入戰場                                              │
│           ↓                                                        │
│  5. 自動加入戰鬥                                                    │
│                                                                     │
│  【增援限制】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 只能派出該城池領地囤放的士兵                                 │ │
│  │ • 行軍中的士兵到達後自動加入                                   │ │
│  │ • 糧草不足無法增援                                             │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 撤退系統

```
┌─────────────────────────────────────────────────────────────────────┐
│                         撤退機制                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【撤退流程】                                                       │
│                                                                     │
│  1. 玩家點擊「撤退」                                                │
│           ↓                                                        │
│  2. 該玩家的士兵開始向入口移動                                      │
│           ↓                                                        │
│  3. 撤退中的士兵仍會被攻擊                                          │
│           ↓                                                        │
│  4. 成功撤退的士兵返回領地                                          │
│                                                                     │
│  【撤退風險】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 撤退時背對敵人，受到額外傷害 (+50%)                          │ │
│  │ • 撤退中無法攻擊                                               │ │
│  │ • 騎兵撤退較快，步兵撤退較慢                                   │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. 戰鬥結算

### 6.1 結算流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        戰鬥結算                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【攻方勝利 - 城池淪陷】                                            │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 攻方:                                                          │ │
│  │ • 獲得城池控制權                                               │ │
│  │ • 獲得戰利品 (資源掠奪)                                        │ │
│  │ • 存活士兵返回/駐守                                            │ │
│  │                                                                │ │
│  │ 守方:                                                          │ │
│  │ • 城池失守 (參見城池失守機制)                                  │ │
│  │ • 該城池領地士兵全部陣亡                                       │ │
│  │ • 產出損失 50%                                                 │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【守方勝利 - 防守成功】                                            │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 守方:                                                          │ │
│  │ • 保住城池                                                     │ │
│  │ • 存活士兵留在城池                                             │ │
│  │ • 城牆損傷需修復                                               │ │
│  │                                                                │ │
│  │ 攻方:                                                          │ │
│  │ • 攻城失敗                                                     │ │
│  │ • 存活士兵撤回出發城池                                         │ │
│  │ • 消耗的糧草不返還                                             │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 戰報系統

```
┌─────────────────────────────────────────────────────────────────────┐
│                        戰報系統                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  戰鬥結束後生成戰報:                                                │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     【戰 報】                               │   │
│  │                                                             │   │
│  │  戰役: 國家A 攻打 城池B                                     │   │
│  │  結果: 攻方勝利                                             │   │
│  │  持續時間: 15分32秒                                         │   │
│  │                                                             │   │
│  │  ────────────────────────────────────────                   │   │
│  │  國家A (攻方)          │  國家B (守方)                      │   │
│  │  ────────────────────────────────────────                   │   │
│  │  投入兵力: 3500        │  投入兵力: 2100                    │   │
│  │  陣亡: 1200            │  陣亡: 2100 (全滅)                 │   │
│  │  存活: 2300            │  存活: 0                           │   │
│  │  ────────────────────────────────────────                   │   │
│  │                                                             │   │
│  │  參戰玩家:                                                  │   │
│  │  • PlayerA: 投入500, 陣亡200, 存活300                       │   │
│  │  • PlayerB: 投入800, 陣亡350, 存活450                       │   │
│  │  • ...                                                      │   │
│  │                                                             │   │
│  │                              [查看回放] [分享]               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. 技術實現考量

### 7.1 服務端架構

```
┌─────────────────────────────────────────────────────────────────────┐
│                      戰鬥服務架構                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                      ┌─────────────────┐                           │
│                      │   Gateway       │                           │
│                      │   Server        │                           │
│                      └────────┬────────┘                           │
│                               │                                     │
│         ┌─────────────────────┼─────────────────────┐              │
│         │                     │                     │              │
│  ┌──────┴──────┐      ┌──────┴──────┐      ┌──────┴──────┐       │
│  │   Battle    │      │   Battle    │      │   Battle    │       │
│  │   Server 1  │      │   Server 2  │      │   Server 3  │       │
│  │ (戰場實例1) │      │ (戰場實例2) │      │ (戰場實例3) │       │
│  └─────────────┘      └─────────────┘      └─────────────┘       │
│                                                                     │
│  每個戰場獨立運算:                                                  │
│  • 戰場實例獨立運行                                                 │
│  • 100ms 一次戰鬥計算                                               │
│  • 產生快照推送給觀戰者                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 性能優化

```
┌─────────────────────────────────────────────────────────────────────┐
│                      性能優化策略                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【大量士兵優化】                                                   │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 問題: 戰場可能有 10000+ 士兵，無法全部獨立渲染                  │ │
│  │                                                                │ │
│  │ 解決方案:                                                      │ │
│  │ 1. 合併顯示: 相近的同類士兵合併為一個「軍團」圖標              │ │
│  │    • 100個步兵 → 顯示為「步兵 ×100」                          │ │
│  │                                                                │ │
│  │ 2. GPU Instancing: 相同士兵共用一個 Draw Call                  │ │
│  │                                                                │ │
│  │ 3. LOD 系統:                                                   │ │
│  │    • 近距離: 顯示單個士兵                                      │ │
│  │    • 遠距離: 顯示軍團圖標                                      │ │
│  │                                                                │ │
│  │ 4. 視野剔除: 只渲染可見區域的士兵                              │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  【網路優化】                                                       │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ • 差量同步: 只傳輸變化的數據                                   │ │
│  │ • 快照壓縮: 使用 MessagePack + LZ4 壓縮                       │ │
│  │ • 觀戰分流: 多個觀戰者共用同一個數據流                         │ │
│  │ • 延遲緩衝: 客戶端緩存 2 秒數據，平滑播放                      │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 8. 數據結構總覽

```csharp
// 戰場實例
public class Battlefield
{
    public int BattlefieldId;
    public int CityId;              // 戰鬥所在城池
    public BattleState State;       // 戰場狀態
    public DateTime StartTime;      // 開始時間

    // 參戰方
    public Dictionary<int, BattleFaction> Factions;  // 國家ID -> 陣營

    // 城牆狀態 (攻城戰)
    public float WallMaxHp;
    public float WallCurrentHp;

    // 所有士兵
    public List<BattleSoldier> Soldiers;
}

// 戰場陣營
public class BattleFaction
{
    public int NationId;
    public FactionRole Role;        // 攻方/守方/第三方
    public int TotalSoldiers;       // 總投入兵力
    public int AliveSoldiers;       // 存活兵力
    public int DeadSoldiers;        // 陣亡兵力
    public List<long> PlayerIds;    // 參戰玩家
}

public enum FactionRole
{
    Attacker,   // 攻方
    Defender,   // 守方
    Third       // 第三方
}

public enum BattleState
{
    Preparing,  // 準備中
    Fighting,   // 戰鬥中
    Settling,   // 結算中
    Ended       // 已結束
}

// 戰場快照 (用於同步)
public class BattleSnapshot
{
    public int BattlefieldId;
    public long Timestamp;
    public float WallHp;
    public List<SoldierSnapshot> Soldiers;
}

public class SoldierSnapshot
{
    public long SoldierId;
    public Vector2 Position;
    public float Hp;
    public SoldierState State;
}
```

---

*文檔創建日期: 2024-12-14*
*版本: 1.2 - 玩家戰場UI顯示個人士兵狀態*
